<!DOCTYPE html>
<html lang="ru">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Ğ˜Ğ³Ğ¾Ñ€Ğ½Ñ‹Ğ¹ ĞºĞ»ÑƒĞ± "Ğ¡Ğ¾Ğ·Ğ²ĞµĞ·Ğ´Ğ¸Ğµ Ğ¾Ñ€Ğ»Ğ°"</title>
Â  Â Â 
Â  Â  <link rel="manifest" href="manifest.json">
Â  Â  <meta name="theme-color" content="#f4e4bc">
Â  Â  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1064/1064024.png">
Â  Â  <link rel="preload" href="./logo.png" as="image">

Â  Â  <link href="https://fonts.googleapis.com/css2?family=Rye&family=Special+Elite&display=swap" rel="stylesheet">
Â  Â  <style>
Â  Â  Â  Â  /* Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞ±Ñ€Ğ¾Ñ */
Â  Â  Â  Â  * { box-sizing: border-box; }

Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --paper-bg: #f4e4bc;
Â  Â  Â  Â  Â  Â  --paper-texture: url('data:image/svg+xml;utf8,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><filter id="noise"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="4" stitchTiles="stitch"/><feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.4 0"/></filter><rect width="100%" height="100%" filter="url(%23noise)" opacity="0.1"/></svg>');
Â  Â  Â  Â  Â  Â  --ink-color: #3e2b1f;
Â  Â  Â  Â  Â  Â  --accent-brown: #8b4513;
Â  Â  Â  Â  Â  Â  --accent-gold: #cba135;
Â  Â  Â  Â  Â  Â  --accent-red: #8b0000;
Â  Â  Â  Â  Â  Â  --accent-green: #2e7d32;
Â  Â  Â  Â  Â  Â  --accent-undo: #d4af37;
Â  Â  Â  Â  Â  Â  --accent-redo: #008b8b;
Â  Â  Â  Â  Â  Â  --accent-purple: #6a0dad;
Â  Â  Â  Â  Â  Â  --accent-orange: #e65100;
Â  Â  Â  Â  Â  Â  --accent-teal: #009688;
Â  Â  Â  Â  Â  Â  --sidebar-width: 260px;
Â  Â  Â  Â  }

Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Special Elite', 'Courier New', monospace;
Â  Â  Â  Â  Â  Â  background-color: #2a1b0f;
Â  Â  Â  Â  Â  Â  background-image: linear-gradient(to bottom, rgba(0,0,0,0.6), rgba(0,0,0,0.1));
Â  Â  Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  Â  Â  color: var(--ink-color);
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  overscroll-behavior: none;
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- SIDEBAR --- */
Â  Â  Â  Â  .sidebar {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  bottom: 0;
Â  Â  Â  Â  Â  Â  width: var(--sidebar-width);
Â  Â  Â  Â  Â  Â  background: #1a1008;
Â  Â  Â  Â  Â  Â  border-right: 4px solid var(--accent-brown);
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  box-shadow: 5px 0 15px rgba(0,0,0,0.5);
Â  Â  Â  Â  Â  Â  z-index: 3500;
Â  Â  Â  Â  Â  Â  transition: transform 0.3s ease;
Â  Â  Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  }
Â  Â  Â  Â  .close-menu-btn {
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 10px;
Â  Â  Â  Â  Â  Â  right: 10px;
Â  Â  Â  Â  Â  Â  background: transparent;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  color: var(--accent-red);
Â  Â  Â  Â  Â  Â  font-size: 2em;
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  z-index: 3002;
Â  Â  Â  Â  Â  Â  padding: 5px;
Â  Â  Â  Â  Â  Â  line-height: 0.8;

Â  Â  Â  Â  }
Â  Â  Â  Â  /* ĞšĞĞĞŸĞšĞ ĞœĞ•ĞĞ® */
Â  Â  Â  Â  .menu-toggle {
Â  Â  Â  Â  Â  Â  display: none;Â 
Â  Â  Â  Â  Â  Â  position: fixed;Â 
Â  Â  Â  Â  Â  Â  top: 15px;
Â  Â  Â  Â  Â  Â  left: 15px;
Â  Â  Â  Â  Â  Â  background: #6b523c;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  color: #4F3D2D;Â  Â 
Â  Â  Â  Â  Â  Â  text-shadow: 1px 1px 0px #30251C, 2px 2px 3px rgba(0,0,0,0.4);Â 
Â  Â  Â  Â  Â  Â  font-size: 2.5em;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  z-index: 3001;
Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  .sidebar-logo { text-align: center; margin-bottom: 30px; }
Â  Â  Â  Â  .sidebar-logo img { width: 100px; border-radius: 50%; border: 2px solid var(--accent-gold); }

Â  Â  Â  Â  /* Ğ˜ĞĞ¤Ğ Ğ Ğ®Ğ—Ğ•Ğ Ğ• Ğ’ ĞœĞ•ĞĞ® */
Â  Â  Â  Â  .user-info-container {
Â  Â  Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  .display-name-row {
Â  Â  Â  Â  Â  Â  font-family: 'Rye', cursive;
Â  Â  Â  Â  Â  Â  color: var(--accent-gold);
Â  Â  Â  Â  Â  Â  font-size: 1.3em;
Â  Â  Â  Â  Â  Â  line-height: 1.2;Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-wrap: wrap;Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;Â 
Â  Â  Â  Â  Â  Â  text-align: center;Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  Â  Â  max-width: 100%;
Â  Â  Â  Â  Â  Â  word-break: break-word;Â Â 
Â  Â  Â  Â  Â  Â  padding: 0 10px;Â  Â  Â  Â  Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .login-name-row {
Â  Â  Â  Â  Â  Â  font-family: 'Special Elite', monospace;
Â  Â  Â  Â  Â  Â  color: #d4c5a3;
Â  Â  Â  Â  Â  Â  font-size: 0.8em;
Â  Â  Â  Â  Â  Â  opacity: 0.6;
Â  Â  Â  Â  Â  Â  margin-top: 4px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .edit-icon {
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-size: 0.8em;
Â  Â  Â  Â  Â  Â  opacity: 0.7;
Â  Â  Â  Â  Â  Â  transition: 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .edit-icon:hover { opacity: 1; transform: scale(1.1); }

Â  Â  Â  Â  .role-badge {
Â  Â  Â  Â  Â  Â  font-size: 1.2em;
Â  Â  Â  Â  Â  Â  margin-right: 5px;
Â  Â  Â  Â  Â  Â  cursor: help;
Â  Â  Â  Â  Â  Â  text-shadow: 1px 1px 0 rgba(0,0,0,0.3);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* ĞĞĞ’Ğ˜Ğ“ĞĞ¦Ğ˜Ğ¯ */
Â  Â  Â  Â  .nav-btn {
Â  Â  Â  Â  Â  Â  background: transparent; border: 1px solid var(--accent-brown); color: #d4c5a3;
Â  Â  Â  Â  Â  Â  padding: 15px; margin-bottom: 10px; text-align: left;
Â  Â  Â  Â  Â  Â  font-family: 'Rye', cursive; font-size: 1.1em; cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: 0.2s; display: flex; align-items: center; gap: 10px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .nav-btn:hover, .nav-btn.active { background: var(--accent-brown); color: var(--accent-gold); border-color: var(--accent-gold); }

Â  Â  Â  Â  /* Ğ¡Ğ§ĞĞ¢Ğ§Ğ˜Ğš Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ™ */
Â  Â  Â  Â  .notification-badge {
Â  Â  Â  Â  Â  Â  background-color: #ff0000;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  border-radius: 50%; /* Ğ”ĞµĞ»Ğ°ĞµÑ‚ ĞºÑ€ÑƒĞ³Ğ»Ñ‹Ğ¼ */
Â  Â  Â  Â  Â  Â  padding: 2px 6px;
Â  Â  Â  Â  Â  Â  font-size: 0.8em;
Â  Â  Â  Â  Â  Â  margin-left: auto; /* ĞŸÑ€Ğ¸Ğ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ Ğ²Ğ¿Ñ€Ğ°Ğ²Ğ¾ */
Â  Â  Â  Â  Â  Â  font-family: sans-serif;
Â  Â  Â  Â  Â  Â  border: 1px solid #fff;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 8px rgba(255, 0, 0, 0.8);
Â  Â  Â  Â  Â  Â  display: none; /* Ğ¡ĞºÑ€Ñ‹Ñ‚, Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ */
Â  Â  Â  Â  Â  Â  animation: pulse-red 2s infinite;
Â  Â  Â  Â  }
Â  Â Â 
Â  Â  Â  Â  .notification-badge.visible {
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  }

Â  Â  Â  Â  @keyframes pulse-red {
Â  Â  Â  Â  Â  Â  0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
Â  Â  Â  Â  Â  Â  70% { box-shadow: 0 0 0 6px rgba(255, 0, 0, 0); }
Â  Â  Â  Â  Â  Â  100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
Â  Â  Â  Â  }

Â  Â  Â  Â  /* ĞšĞĞĞŸĞšĞ Ğ¡Ğ‘Ğ ĞĞ¡Ğ */
Â  Â  Â  Â  .btn-extreme-reset {
Â  Â  Â  Â  Â  Â  margin-top: auto; background-color: #500000; color: #ffcccc; border: 2px solid #ff0000;
Â  Â  Â  Â  Â  Â  padding: 12px; font-family: 'Special Elite', monospace; font-weight: bold; font-size: 0.9em;
Â  Â  Â  Â  Â  Â  cursor: pointer; width: 100%; border-radius: 4px; transition: all 0.2s; text-align: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-extreme-reset:hover { background-color: #ff0000; color: white; box-shadow: 0 0 15px rgba(255, 0, 0, 0.5); }


Â  Â  Â  Â  /* --- MAIN CONTENT --- */
Â  Â  Â  Â  .main-content {
Â  Â  Â  Â  Â  Â  margin-left: var(--sidebar-width);Â 
Â  Â  Â  Â  Â  Â  width: calc(100% - var(--sidebar-width));
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  background-image: var(--paper-texture);
Â  Â  Â  Â  Â  Â  background-color: var(--paper-bg);
Â  Â  Â  Â  Â  Â  padding-bottom: 60px;
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- HEADER & BRAND --- */
Â  Â  Â  Â  .brand-container {
Â  Â  Â  Â  Â  Â  display: flex; align-items: center; justify-content: center;
Â  Â  Â  Â  Â  Â  margin-bottom: 20px; border-bottom: none;
Â  Â  Â  Â  Â  Â  padding-bottom: 15px; flex-wrap: wrap; text-align: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  .header-title {
Â  Â  Â  Â  Â  Â  font-family: 'Rye', cursive; text-align: center; color: var(--accent-brown);
Â  Â  Â  Â  Â  Â  font-size: 2.2em; margin: 0; text-shadow: 2px 2px 0px var(--paper-bg), 4px 4px 0px rgba(0,0,0,0.2);
Â  Â  Â  Â  Â  Â  text-transform: uppercase; letter-spacing: 2px; line-height: 1.2; width: 100%;
Â  Â  Â  Â  }
Â  Â  Â  Â  .online-counter {
Â  Â  Â  Â  Â  Â  text-align: center; font-family: 'Special Elite', monospace; font-size: 1.1em;
Â  Â  Â  Â  Â  Â  color: var(--accent-green); background: rgba(46, 125, 50, 0.1);
Â  Â  Â  Â  Â  Â  padding: 5px 15px; border-radius: 20px; border: 1px solid var(--accent-green);
Â  Â  Â  Â  Â  Â  display: inline-block; margin: 0 auto 15px auto; font-weight: bold;
Â  Â  Â  Â  }
Â  Â  Â  Â  .center-wrap { text-align: center; }

Â  Â  Â  Â  /* --- STATUS DOT --- */
Â  Â  Â  Â  .status-dot {
Â  Â  Â  Â  Â  Â  display: inline-block; width: 12px; height: 12px; border-radius: 50%;
Â  Â  Â  Â  Â  Â  background-color: #d32f2f; border: 2px solid rgba(0,0,0,0.3);
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 5px rgba(0,0,0,0.5); transition: all 0.3s ease;
Â  Â  Â  Â  Â  Â  vertical-align: middle; margin-left: 8px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .status-dot.online { background-color: #00e676; box-shadow: 0 0 8px #00e676; border-color: #1b5e20; }

Â  Â  Â  Â  /* --- LOGIN OVERLAY --- */
Â  Â  Â  Â  #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2a1b0f; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
Â  Â  Â  Â  .login-card { background-image: var(--paper-texture); background-color: var(--paper-bg); padding: 30px; border: 4px solid var(--accent-brown); border-radius: 8px; text-align: center; width: 300px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
Â  Â  Â  Â  .login-card h2 { font-family: 'Rye', cursive; color: var(--accent-brown); margin-bottom: 20px; border-bottom: 2px double var(--accent-brown); }
Â  Â  Â  Â  .login-input { width: 100%; padding: 10px; margin-bottom: 15px; border: 2px solid var(--accent-brown); background: rgba(255,255,255,0.5); font-family: 'Special Elite', monospace; font-size: 1.1em; box-sizing: border-box; }
Â  Â  Â  Â  .login-checkbox { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; font-size: 0.9em; color: var(--accent-brown); }
Â  Â  Â  Â  .btn-login-action { width: 100%; padding: 12px; margin-bottom: 10px; background: var(--accent-green); color: white; border: 2px solid #1b5e20; font-family: 'Rye', cursive; cursor: pointer; font-size: 1.1em; border-radius: 4px; }
Â  Â  Â  Â  .btn-register { background: var(--accent-brown); border-color: #5d4037; }
Â  Â  Â  Â  .btn-register-link { background: transparent; border: none; color: var(--accent-gold); font-family: 'Rye', cursive; font-size: 1em; cursor: pointer; text-decoration: underline; margin-top: 10px; }
Â  Â  Â  Â  .btn-back { background: var(--accent-red); border-color: #b71c1c; }
Â  Â  Â  Â  .error-msg { color: red; margin-top: 10px; font-weight: bold; min-height: 1.2em; }

Â  Â  Â  Â  .version-tag { position: fixed; bottom: 5px; right: 10px; font-size: 0.7em; color: #5a3a22; font-family: 'Special Elite', monospace; z-index: 2000; background: rgba(244, 228, 188, 0.9); padding: 2px 6px; border-radius: 4px; border: 1px solid #8b4513; pointer-events: none; opacity: 0.8; cursor: pointer; text-decoration: underline; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .network-badge { position: fixed; top: 15px; right: 15px; padding: 8px 15px; font-family: 'Rye', cursive; font-size: 0.9em; border-radius: 4px; z-index: 1000; box-shadow: 2px 2px 5px rgba(0,0,0,0.7); border: 2px solid #3e2b1f; transition: all 0.3s; text-transform: uppercase; }
Â  Â  Â  Â  .status-online { background-color: var(--accent-green); color: #fff; border-color: #1b5e20; }
Â  Â  Â  Â  .status-offline { background-color: #d32f2f; color: #fff; border-color: #b71c1c; animation: pulse 2s infinite; }

Â  Â  Â  Â  .date-section {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  Â  Â  margin: 10px auto 20px auto; /* ĞÑ‚ÑÑ‚ÑƒĞ¿Ñ‹ ÑĞ²ĞµÑ€Ñ…Ñƒ Ğ¸ ÑĞ½Ğ¸Ğ·Ñƒ */
Â  Â  Â  Â  Â  Â  padding: 5px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .date-section label {
Â  Â  Â  Â  Â  Â  font-family: 'Rye', cursive;
Â  Â  Â  Â  Â  Â  color: var(--accent-brown);
Â  Â  Â  Â  Â  Â  font-size: 1.2em;
Â  Â  Â  Â  }

Â  Â  Â  Â  input[type="date"] {
Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.6);
Â  Â  Â  Â  Â  Â  border: 2px solid var(--accent-brown);
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  Â  Â  padding: 8px 12px;
Â  Â  Â  Â  Â  Â  font-family: 'Special Elite', monospace;
Â  Â  Â  Â  Â  Â  font-size: 1.1em;
Â  Â  Â  Â  Â  Â  color: #3e2b1f;
Â  Â  Â  Â  Â  Â  outline: none;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â  .controls { margin-bottom: 25px; display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; padding-bottom: 20px; border-bottom: 2px solid var(--accent-brown); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  button { padding: 12px 20px; border: 2px solid rgba(0,0,0,0.3); border-radius: 3px; cursor: pointer; font-size: 15px; font-family: 'Rye', cursive; text-transform: uppercase; letter-spacing: 1px; transition: all 0.2s; box-shadow: inset 0 0 10px rgba(255,255,255,0.2), 2px 2px 3px rgba(0,0,0,0.3); text-shadow: 1px 1px 1px rgba(0,0,0,0.5); position: relative; top: 0; }
Â  Â  Â  Â  button:active { top: 2px; box-shadow: inset 0 0 5px rgba(0,0,0,0.4); }
Â  Â  Â  Â  .btn-add { background-color: var(--accent-green); color: #f4e4bc; border-color: #3a4a20; }
Â  Â  Â  Â  .btn-download { background-color: var(--accent-brown); color: var(--accent-gold); border-color: #5c300e; }
Â  Â  Â  Â  .btn-newday { background-color: var(--accent-purple); color: #fff; border-color: #4b0082; }
Â  Â  Â  Â  .btn-newday:hover { background-color: #5a0a94; }
Â  Â  Â  Â  .btn-refresh { background-color: var(--accent-teal); color: white; border-color: #00796b; }
Â  Â  Â  Â  .btn-refresh:hover { background-color: #00796b; }
Â  Â  Â  Â  .btn-calc, .btn-undo, .btn-redo { width: 40px; height: 40px; padding: 0; font-family: 'Special Elite', monospace; font-weight: bold; font-size: 1.5em; border-radius: 50%; border: 2px solid #3e2b1f; display: inline-flex; align-items: center; justify-content: center; margin: 0 2px; }
Â  Â  Â  Â  .btn-calc { background-color: #6b523d; color: var(--accent-gold); }
Â  Â  Â  Â  .btn-undo { background-color: var(--accent-undo); color: #3e2b1f; font-size: 1.2em; }
Â  Â  Â  Â  .btn-redo { background-color: var(--accent-redo); color: #fff; font-size: 1.2em; }
Â  Â  Â  Â  .btn-redo:hover { background-color: #00aaaa; }
Â  Â  Â  Â  .btn-delete { background-color: var(--accent-red); color: #f4e4bc; font-weight: bold; border-radius: 50%; width: 30px; height: 30px; padding: 0; border: 2px solid #500000; font-family: sans-serif; cursor: pointer; }
Â  Â  Â  Â  .btn-reset-player { background-color: var(--accent-orange); color: white; font-weight: bold; border-radius: 50%; width: 30px; height: 30px; padding: 0; border: 2px solid #bf360c; font-family: sans-serif; cursor: pointer; }
Â  Â  Â  Â  .btn-reset-player:hover { background-color: #ff6d00; }

Â  Â  Â  Â  table { width: 100%; border-collapse: separate; border-spacing: 0 10px; margin-top: 10px; }
Â  Â  Â  Â  th { padding: 15px 10px; text-align: left; background-color: #6b523d; color: var(--accent-gold); font-family: 'Rye', cursive; letter-spacing: 1px; border-top: 3px solid #3e2b1f; border-bottom: 3px solid #3e2b1f; }
Â  Â  Â  Â  tbody tr { background-color: rgba(255, 255, 255, 0.4); box-shadow: 2px 2px 4px rgba(0,0,0,0.1); border: 1px solid var(--accent-brown); }
Â  Â  Â  Â  td { padding: 15px 10px; border-top: 1px dashed rgba(139, 69, 19, 0.3); border-bottom: 2px solid var(--accent-brown); vertical-align: middle; }
Â  Â  Â  Â  input[type="text"], input[type="number"] { padding: 8px; background: transparent; border: none; border-bottom: 2px dashed var(--accent-brown); font-family: 'Special Elite', monospace; font-size: 1.1em; color: var(--ink-color); box-sizing: border-box; outline: none; }
Â  Â  Â  Â  input[type="text"].player-name { width: 100%; cursor: default; color: var(--accent-brown); font-weight: bold; }
Â  Â  Â  Â  input[type="text"] { width: 100%; }
Â  Â  Â  Â  input[type="number"] { width: 70px; margin-right: 5px; text-align: center; border: 2px solid var(--accent-brown); background-color: #f9f3e3; }
Â  Â  Â  Â  .score-cell { font-family: 'Rye', cursive; font-size: 1.8em; color: var(--accent-red); text-align: center; }
Â  Â  Â  Â  .history-log { font-size: 0.9em; color: #6b523d; font-style: italic; max-width: 250px; overflow-x: auto; white-space: nowrap; padding: 5px; background-color: rgba(139, 69, 19, 0.05); border-radius: 4px; }

Â  Â  Â  Â  /* ĞšĞ½Ğ¾Ğ¿ĞºĞ° Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ */
Â  Â  Â  Â  .btn-local-note {
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-size: 1.2em;
Â  Â  Â  Â  Â  Â  margin-left: 5px;
Â  Â  Â  Â  Â  Â  opacity: 0.3;
Â  Â  Â  Â  Â  Â  transition: 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-local-note:hover { opacity: 1; transform: scale(1.1); }
Â  Â Â 
Â  Â  /* Ğ•ÑĞ»Ğ¸ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ° ĞµÑÑ‚ÑŒ - ĞºĞ½Ğ¾Ğ¿ĞºĞ° ÑÑ€ĞºĞ°Ñ */
Â  Â  Â  Â  .btn-local-note.has-note {
Â  Â  Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  Â  Â  text-shadow: 0 0 5px gold;
Â  Â  Â  Â  }

Â  Â  /* Ğ¢ĞµĞºÑÑ‚ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ Ğ¿Ğ¾Ğ´ Ğ¸Ğ¼ĞµĞ½ĞµĞ¼ */
Â  Â  Â  Â  .player-note-text {
Â  Â  Â  Â  Â  Â  font-family: 'Courier New', monospace;
Â  Â  Â  Â  Â  Â  font-size: 0.75em;
Â  Â  Â  Â  Â  Â  color: #b71c1c; /* Ğ¢ĞµĞ¼Ğ½Ğ¾-ĞºÑ€Ğ°ÑĞ½Ñ‹Ğ¹ */
Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  margin-top: 2px;
Â  Â  Â  Â  Â  Â  margin-left: 20px; /* ĞÑ‚ÑÑ‚ÑƒĞ¿ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ±Ñ‹Ğ»Ğ¾ ĞºÑ€Ğ°ÑĞ¸Ğ²Ğ¾ */
Â  Â  Â  Â  Â  Â  font-style: italic;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  word-wrap: break-word;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* ĞšĞ½Ğ¾Ğ¿ĞºĞ° Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ñ‡Ğ°Ñ‚ (Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ) */
Â  Â  Â  Â  .btn-start-dm {
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-size: 1.2em;
Â  Â  Â  Â  Â  Â  margin-right: 8px;
Â  Â  Â  Â  Â  Â  color: var(--accent-brown);
Â  Â  Â  Â  Â  Â  transition: 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-start-dm:hover { transform: scale(1.2); color: var(--accent-orange); }

Â  Â  /* Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº Ğ¿Ñ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ğ¾Ğ³Ğ¾ Ñ‡Ğ°Ñ‚Ğ° */
Â  Â  Â  Â  .chat-header-private {
Â  Â  Â  Â  Â  Â  background-color: #ffe0b2;
Â  Â  Â  Â  Â  Â  color: #e65100;
Â  Â  Â  Â  Â  Â  padding: 5px 10px;
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  border: 1px solid #e65100;
Â  Â  Â  Â  Â  Â  font-family: 'Special Elite', monospace;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-back-general {
Â  Â  Â  Â  Â  Â  background: var(--accent-brown);
Â  Â  Â  Â  Â  Â  color: var(--accent-gold);
Â  Â  Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-family: 'Rye', cursive;
Â  Â  Â  Â  Â  Â  padding: 5px 10px;
Â  Â  Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  Â  Â  font-size: 0.8em;
Â  Â  Â  Â  }


Â  Â  Â  Â  /* --- Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡Ğ« Ğ˜Ğ“Ğ ĞĞšĞĞ’ --- */
Â  Â  Â  Â  .status-cell { font-family: 'Special Elite', monospace; font-weight: bold; font-size: 0.9em; text-align: center; }
Â  Â Â 
Â  Â  Â  Â  .st-dvornik { color: #7f8c8d; } /* Ğ¡ĞµÑ€Ñ‹Ğ¹ */
Â  Â  Â  Â  .st-novoÂ  Â  { color: #2ecc71; } /* Ğ—ĞµĞ»ĞµĞ½Ñ‹Ğ¹ */
Â  Â  Â  Â  .st-midÂ  Â  Â { color: #3498db; } /* Ğ¡Ğ¸Ğ½Ğ¸Ğ¹ */
Â  Â  Â  Â  .st-richÂ  Â  { color: #9b59b6; font-weight: 900; } /* Ğ¤Ğ¸Ğ¾Ğ»ĞµÑ‚Ğ¾Ğ²Ñ‹Ğ¹ */
Â  Â  Â  Â  .st-donateÂ  { color: #f1c40f; text-shadow: 0 0 5px #f1c40f; } /* Ğ—Ğ¾Ğ»Ğ¾Ñ‚Ğ¾Ğ¹ */
Â  Â  Â  Â  .st-cheatÂ  Â { color: #ff0000; text-shadow: 2px 2px 0px black; animation: pulse 0.5s infinite; letter-spacing: 1px; } /* ĞĞ³Ñ€ĞµÑÑĞ¸Ğ²Ğ½Ñ‹Ğ¹ ĞºÑ€Ğ°ÑĞ½Ñ‹Ğ¹ */

Â  Â  /* ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ˜Ğ• ĞœĞĞ‘Ğ˜Ğ›Ğ¬ĞĞĞ™ Ğ’Ğ•Ğ Ğ¡Ğ˜Ğ˜ (Ñ‚Ğ°Ğº ĞºĞ°Ğº Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ»Ğ°ÑÑŒ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ°) */
Â  Â  Â  Â  @media screen and (max-width: 768px) {
Â  Â  Â  Â  /* Ğ˜Ğ¼Ñ */
Â  Â  Â  Â  Â  Â  td:nth-of-type(1) { margin-bottom: 5px; border-bottom: none; padding-bottom: 0; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ (ĞĞ¾Ğ²Ğ°Ñ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ° 2) */
Â  Â  Â  Â  Â  Â  td:nth-of-type(2) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1.2em;Â 
Â  Â  Â  Â  Â  Â  Â  Â  padding: 5px 0 15px 0;Â 
Â  Â  Â  Â  Â  Â  Â  Â  border-bottom: 2px solid rgba(139, 69, 19, 0.2);Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ (Ğ¢ĞµĞ¿ĞµÑ€ÑŒ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ° 3) */
Â  Â  Â  Â  Â  Â  td:nth-of-type(3) { display: flex; justify-content: center; flex-wrap: wrap; gap: 5px; margin: 5px 0; }
Â  Â  Â  Â  Â  Â  td:nth-of-type(3) input { width: 60px; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Ğ˜Ñ‚Ğ¾Ğ³ (Ğ¢ĞµĞ¿ĞµÑ€ÑŒ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ° 4) */
Â  Â  Â  Â  Â  Â  td:nth-of-type(4) { margin: 5px 0; font-size: 2.2em; font-weight: bold; color: var(--accent-red); }
Â  Â  Â  Â  Â  Â  td:nth-of-type(4)::before { content: "Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ"; display: block; font-size: 0.4em; color: #8b4513; text-transform: uppercase; letter-spacing: 2px; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ (Ğ¢ĞµĞ¿ĞµÑ€ÑŒ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ° 5) */
Â  Â  Â  Â  Â  Â  td:nth-of-type(5) { font-size: 0.8em; color: #666; background: rgba(255,255,255,0.5); padding: 5px; border-radius: 4px; max-width: 100%; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ (Ğ¢ĞµĞ¿ĞµÑ€ÑŒ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ° 6) */
Â  Â  Â  Â  Â  Â  td:nth-of-type(6) { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; padding: 0; }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* CHAT */
Â  Â  Â  Â  .chat-wrapper { display: flex; flex-direction: column; height: calc(100vh - 100px); }
Â  Â  Â  Â  .chat-messages { flex: 1; overflow-y: auto; padding: 10px; background: rgba(255, 255, 255, 0.3); border: 2px solid var(--accent-brown); border-radius: 8px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px; }
Â  Â  Â  Â  .message-bubble { max-width: 80%; padding: 8px 12px; border-radius: 12px; position: relative; font-family: 'Special Elite', monospace; font-size: 1em; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); }
Â  Â  Â  Â  .message-sender { font-size: 0.75em; font-weight: bold; margin-bottom: 2px; display: block; font-family: 'Rye', cursive; }
Â  Â  Â  Â  .msg-time {
Â  Â  Â  Â  Â  Â  font-size: 0.8em;
Â  Â  Â  Â  Â  Â  opacity: 0.6;
Â  Â  Â  Â  Â  Â  margin-left: 8px;
Â  Â  Â  Â  Â  Â  font-weight: normal;
Â  Â  Â  Â  Â  Â  float: right; /* Ğ’Ñ€ĞµĞ¼Ñ Ğ±ÑƒĞ´ĞµÑ‚ ÑĞ¿Ñ€Ğ°Ğ²Ğ° */
Â  Â  Â  Â  }
Â  Â  Â  Â  /* ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹ Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ÑĞ¼Ğ¸ */
Â  Â  Â  Â  .msg-actions {
Â  Â  Â  Â  Â  Â  display: inline-flex;
Â  Â  Â  Â  Â  Â  gap: 5px;
Â  Â  Â  Â  Â  Â  margin-left: 8px;
Â  Â  Â  Â  Â  Â  opacity: 0.6;
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-msg-action {
Â  Â  Â  Â  Â  Â  background: transparent;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-size: 0.9em;
Â  Â  Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  Â  Â  color: inherit;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* ĞœĞµÑ‚ĞºĞ° (Ñ€ĞµĞ´.) */
Â  Â  Â  Â  .edited-label {
Â  Â  Â  Â  Â  Â  font-size: 0.7em;
Â  Â  Â  Â  Â  Â  color: #888;
Â  Â  Â  Â  Â  Â  font-style: italic;
Â  Â  Â  Â  Â  Â  margin-left: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* ĞŸĞ¾Ğ´ÑĞ²ĞµÑ‚ĞºĞ° Ğ¿Ğ¾Ğ»Ñ Ğ²Ğ²Ğ¾Ğ´Ğ° Ğ¿Ñ€Ğ¸ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¸ */
Â  Â  Â  Â  .input-editing {
Â  Â  Â  Â  Â  Â  background-color: #fff8e1 !important;
Â  Â  Â  Â  Â  Â  border-color: #ffb300 !important;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 5px rgba(255, 179, 0, 0.5);
Â  Â  Â  Â  }

/* Ğ¡Ñ‚Ğ¸Ğ»ÑŒ Ğ´Ğ°Ñ‚Ñ‹ Ğ¸ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ */
Â  Â  Â  Â  .msg-meta {
Â  Â  Â  Â  Â  Â  font-size: 0.7em;
Â  Â  Â  Â  Â  Â  color: #6b523d;
Â  Â  Â  Â  Â  Â  opacity: 0.7;
Â  Â  Â  Â  Â  Â  float: right;
Â  Â  Â  Â  Â  Â  margin-left: 10px;
Â  Â  Â  Â  Â  Â  margin-top: 2px;
Â  Â  Â  Â  }
Â  Â Â 
Â  Â  /* Ğ‘Ğ»Ğ¾Ğº ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº (Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ/ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ) */
Â  Â  Â  Â  .msg-actions {
Â  Â  Â  Â  Â  Â  display: inline-flex;
Â  Â  Â  Â  Â  Â  gap: 5px;
Â  Â  Â  Â  Â  Â  margin-left: 8px;
Â  Â  Â  Â  Â  Â  opacity: 0.5;
Â  Â  Â  Â  Â  Â  transition: 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .message-bubble:hover .msg-actions { opacity: 1; }

Â  Â  Â  Â  .msg-btn {
Â  Â  Â  Â  Â  Â  background: transparent;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-size: 1em;
Â  Â  Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  Â  Â  color: inherit;
Â  Â  Â  Â  }
Â  Â  Â  Â  .msg-btn:hover { transform: scale(1.2); color: #000; }

Â  Â  /* Ğ ĞµĞ¶Ğ¸Ğ¼ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ (Ğ¿Ğ¾Ğ´ÑĞ²ĞµÑ‚ĞºĞ° Ğ¿Ğ¾Ğ»Ñ Ğ²Ğ²Ğ¾Ğ´Ğ°) */
Â  Â  Â  Â  .editing-mode {
Â  Â  Â  Â  Â  Â  background-color: #fff3e0 !important; /* Ğ¡Ğ²ĞµÑ‚Ğ»Ğ¾-Ğ¾Ñ€Ğ°Ğ½Ğ¶ĞµĞ²Ñ‹Ğ¹ Ñ„Ğ¾Ğ½ */
Â  Â  Â  Â  Â  Â  border-color: #ff9800 !important;Â  Â  Â  /* ĞÑ€Ğ°Ğ½Ğ¶ĞµĞ²Ğ°Ñ Ñ€Ğ°Ğ¼ĞºĞ° */
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 8px rgba(255, 152, 0, 0.5) !important;
Â  Â  Â  Â  }
Â  Â Â 
Â  Â  /* ĞœĞµÑ‚ĞºĞ° (Ñ€ĞµĞ´.) */
Â  Â  Â  Â  .edited-label {
Â  Â  Â  Â  Â  Â  font-size: 0.7em;
Â  Â  Â  Â  Â  Â  font-style: italic;
Â  Â  Â  Â  Â  Â  color: #888;
Â  Â  Â  Â  Â  Â  margin-left: 4px;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .btn-msg-action:hover { opacity: 1; transform: scale(1.2); }
Â  Â  Â  Â  .my-message { align-self: flex-end; background-color: #e8f5e9; border: 1px solid var(--accent-green); border-bottom-right-radius: 0; }
Â  Â  Â  Â  .my-message .message-sender { color: var(--accent-green); text-align: right; }
Â  Â  Â  Â  .other-message { align-self: flex-start; background-color: #fff8e1; border: 1px solid var(--accent-brown); border-bottom-left-radius: 0; }
Â  Â  Â  Â  .other-message .message-sender { color: var(--accent-brown); }
Â  Â  Â  Â  .chat-input-bar { display: flex; gap: 10px; }
Â  Â  Â  Â  .chat-input { flex: 1; padding: 10px; border: 2px solid var(--accent-brown); border-radius: 4px; font-family: 'Special Elite', monospace; background: #fff; }
Â  Â  Â  Â  .btn-send { background-color: var(--accent-brown); color: var(--accent-gold); border: none; padding: 0 20px; border-radius: 4px; cursor: pointer; font-family: 'Rye', cursive; }

Â  Â  Â  Â  /* Ğ˜Ğ¢ĞĞ“ */
Â  Â  Â  Â  .grand-total-panel { margin-top: 20px; background: linear-gradient(145deg, #3e2b1f, #2a1b0f); border: 3px solid var(--accent-gold); border-radius: 12px; padding: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 10px 25px rgba(0,0,0,0.6), inset 0 0 20px rgba(0,0,0,0.5); position: relative; overflow: hidden; }
Â  Â  Â  Â  .grand-total-panel::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%); pointer-events: none; }
Â  Â  Â  Â  .gt-label { font-family: 'Rye', cursive; font-size: 1.5em; color: var(--accent-gold); text-transform: uppercase; letter-spacing: 2px; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); }
Â  Â  Â  Â  .gt-value { font-family: 'Rye', cursive; font-size: 2.5em; color: #fff; font-weight: bold; text-shadow: 0 0 10px rgba(203, 161, 53, 0.5), 3px 3px 0px #000; }

Â  Â  Â  Â  /* Ğ–Ğ£Ğ ĞĞĞ› */
Â  Â  Â  Â  .journal-list { display: flex; flex-direction: column; gap: 15px; }
Â  Â  Â  Â  .journal-card { background: rgba(255, 255, 255, 0.6); border: 2px solid var(--accent-brown); padding: 15px; cursor: pointer; transition: 0.2s; }
Â  Â  Â  Â  .journal-card:hover { background: rgba(255, 255, 255, 0.9); }
Â  Â  Â  Â  .journal-header { display: flex; justify-content: space-between; align-items: center; font-family: 'Rye', cursive; font-size: 1.1em; color: var(--accent-brown); }
Â  Â  Â  Â  .journal-details { display: none; margin-top: 15px; border-top: 1px dashed var(--accent-brown); padding-top: 10px; }
Â  Â  Â  Â  .journal-card.open .journal-details { display: block; }
Â  Â  Â  Â  .detail-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dotted #ccc; font-size: 0.9em; }
Â  Â  Â  Â  .hidden { display: none; }
Â  Â  Â  Â  .btn-journal-delete { background: var(--accent-red); color: #fff; border: 1px solid #500; border-radius: 4px; padding: 3px 8px; font-size: 0.8em; margin-left: 10px; cursor: pointer; font-weight: bold; transition: background 0.2s; }
Â  Â  Â  Â  .btn-journal-delete:hover { background: #a00000; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .name-wrapper { display: flex; align-items: center; width: 100%; }
Â  Â  Â  Â  .player-status-indicator { width: 10px; height: 10px; border-radius: 50%; background-color: #d32f2f; border: 1px solid rgba(0,0,0,0.3); margin-right: 8px; box-shadow: 0 0 2px rgba(0,0,0,0.5); transition: all 0.3s ease; flex-shrink: 0; }
Â  Â  Â  Â  .player-status-indicator.is-online { background-color: #00e676; box-shadow: 0 0 6px #00e676; border-color: #1b5e20; }

Â  Â  Â  Â  /* MOBILE (Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ ĞŸĞĞ” ĞĞĞ’Ğ«Ğ• ĞšĞĞ›ĞĞĞšĞ˜) */
Â  Â  Â  Â  @media screen and (max-width: 768px) {
Â  Â  Â  Â  Â  Â  .sidebar { transform: translateX(-100%); width: 260px; }
Â  Â  Â  Â  Â  Â  .sidebar.open { transform: translateX(0); }
Â  Â  Â  Â  Â  Â  .main-content { margin-left: 0; width: 100%; padding-top: 60px; }
Â  Â  Â  Â  Â  Â  .menu-toggle { display: flex; align-items: center; justify-content: center; gap: 6px; line-height: 1; padding: 0; margin-top: -3px; }
Â  Â  Â  Â  Â  Â  .brand-container { flex-direction: column; gap: 10px; }
Â  Â  Â  Â  Â  Â  .header-title { margin-right: 0; font-size: 1.8em; padding-top: 15px; line-height: 1.4; }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* Ğ¡ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ ÑˆĞ°Ğ¿ĞºÑƒ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ */
Â  Â  Â  Â  Â  Â  thead { display: none; }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* ĞŸÑ€ĞµĞ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ğ² ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ */
Â  Â  Â  Â  Â  Â  table, tbody, tr, td { display: block; }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  tbody tr {Â 
Â  Â  Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.6);Â 
Â  Â  Â  Â  Â  Â  Â  Â  border: 2px solid var(--accent-brown);Â 
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 8px;Â 
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 25px;Â 
Â  Â  Â  Â  Â  Â  Â  Â  padding: 15px;Â 
Â  Â  Â  Â  Â  Â  Â  Â  position: relative;Â 
Â  Â  Â  Â  Â  Â  Â  Â  box-shadow: 3px 3px 8px rgba(0,0,0,0.2);Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  td { padding: 5px 0; border: none; text-align: center; }

Â  Â  Â  Â  Â  Â  /* 1. Ğ˜ĞœĞ¯ (Ğ¡Ğ»ĞµĞ²Ğ° ÑĞ²ĞµÑ€Ñ…Ñƒ) */
Â  Â  Â  Â  Â  Â  td:nth-of-type(1) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  text-align: left;Â 
Â  Â  Â  Â  Â  Â  Â  Â  padding-right: 85px; /* Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚ÑÑ‚ÑƒĞ¿, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ½Ğ°ĞµĞ·Ğ¶Ğ°Ğ»Ğ¾ Ğ½Ğ° ĞºĞ½Ğ¾Ğ¿ĞºÑƒ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ */
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 5px;
Â  Â  Â  Â  Â  Â  Â  Â  display: flex;Â  Â  Â  Â /* Ğ’ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Flex, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸Ğ¼Ñ Ğ¸ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ° ÑÑ‚Ğ¾ÑĞ»Ğ¸ Ñ€Ğ¾Ğ²Ğ½Ğ¾ */
Â  Â  Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  Â  Â  flex-wrap: wrap;Â  Â  Â /* Ğ Ğ°Ğ·Ñ€ĞµÑˆĞ°ĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ½Ğ¾Ñ, ĞµÑĞ»Ğ¸ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ° Ğ´Ğ»Ğ¸Ğ½Ğ½Ğ°Ñ */
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¿Ğ¾Ğ»Ñ Ğ²Ğ²Ğ¾Ğ´Ğ° Ğ¸Ğ¼ĞµĞ½Ğ¸ */
Â  Â  Â  Â  Â  Â  td:nth-of-type(1) input {Â 
Â  Â  Â  Â  Â  Â  Â  Â  font-weight: bold;Â 
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1.4em;Â 
Â  Â  Â  Â  Â  Â  Â  Â  color: var(--accent-brown);Â 
Â  Â  Â  Â  Â  Â  Â  Â  border-bottom: none;Â 
Â  Â  Â  Â  Â  Â  Â  Â  /* width: 100%;Â  <-- Ğ£Ğ”ĞĞ›Ğ•ĞĞ, ÑÑ‚Ğ¾ Ğ»Ğ¾Ğ¼Ğ°Ğ»Ğ¾ Ğ²ĞµÑ€ÑÑ‚ĞºÑƒ */
Â  Â  Â  Â  Â  Â  Â  Â  flex: 1;Â  Â  Â  Â  Â /* <-- Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ: Ğ—Ğ°Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ²Ğ¾Ğ±Ğ¾Ğ´Ğ½Ğ¾Ğµ Ğ¼ĞµÑÑ‚Ğ¾ */
Â  Â  Â  Â  Â  Â  Â  Â  min-width: 50px; /* Ğ§Ñ‚Ğ¾Ğ±Ñ‹ ÑĞ¾Ğ²ÑĞµĞ¼ Ğ½Ğµ ÑĞ¶Ğ°Ğ»Ğ¾ÑÑŒ */
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* ĞŸĞ¾Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ Ğ½Ğ° Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğµ */
Â  Â  Â  Â  Â  Â  .btn-local-note {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1.5em; /* Ğ”ĞµĞ»Ğ°ĞµĞ¼ Ğ¿Ğ¾ĞºÑ€ÑƒĞ¿Ğ½ĞµĞµ Ğ´Ğ»Ñ Ğ¿Ğ°Ğ»ÑŒÑ†Ğ° */
Â  Â  Â  Â  Â  Â  Â  Â  padding: 5px;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* Ğ¢ĞµĞºÑÑ‚ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ¸ Ğ½Ğ° Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞ½Ğ¾ÑĞ¸Ğ¼ Ğ½Ğ° Ğ½Ğ¾Ğ²ÑƒÑ ÑÑ‚Ñ€Ğ¾ĞºÑƒ */
Â  Â  Â  Â  Â  Â  .player-note-text {
Â  Â  Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  Â  Â  margin-left: 0;
Â  Â  Â  Â  Â  Â  Â  Â  margin-top: 5px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /* 2. Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡ (ĞŸĞ¾Ğ´ Ğ¸Ğ¼ĞµĞ½ĞµĞ¼) */
Â  Â  Â  Â  Â  Â  td:nth-of-type(2) {
Â  Â  Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  Â  Â  Â  Â  padding-bottom: 10px;
Â  Â  Â  Â  Â  Â  Â  Â  border-bottom: 2px dashed rgba(139, 69, 19, 0.2);
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1.1em;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /* 3. Ğ”Ğ•Ğ™Ğ¡Ğ¢Ğ’Ğ˜Ğ¯ (ĞšĞ½Ğ¾Ğ¿ĞºĞ¸) */
Â  Â  Â  Â  Â  Â  td:nth-of-type(3) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  Â  Â  justify-content: center;Â 
Â  Â  Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  Â  Â  Â  flex-wrap: wrap;Â 
Â  Â  Â  Â  Â  Â  Â  Â  gap: 8px;Â 
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 15px;Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  td:nth-of-type(3) input { width: 70px; font-size: 1.2em; }

Â  Â  Â  Â  Â  Â  /* 4. Ğ˜Ğ¢ĞĞ“ (Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ - ĞšÑ€ÑƒĞ¿Ğ½Ğ¾) */
Â  Â  Â  Â  Â  Â  td:nth-of-type(4) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  margin: 10px 0;Â 
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 2.5em;Â 
Â  Â  Â  Â  Â  Â  Â  Â  font-weight: bold;Â 
Â  Â  Â  Â  Â  Â  Â  Â  color: var(--accent-red);Â 
Â  Â  Â  Â  Â  Â  Â  Â  line-height: 1;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  td:nth-of-type(4)::before {Â 
Â  Â  Â  Â  Â  Â  Â  Â  content: "Ğ¢Ğ•ĞšĞ£Ğ©Ğ˜Ğ™ Ğ‘ĞĞ›ĞĞĞ¡";Â 
Â  Â  Â  Â  Â  Â  Â  Â  display: block;Â 
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 0.3em;Â 
Â  Â  Â  Â  Â  Â  Â  Â  color: #8b4513;Â 
Â  Â  Â  Â  Â  Â  Â  Â  text-transform: uppercase;Â 
Â  Â  Â  Â  Â  Â  Â  Â  letter-spacing: 2px;Â 
Â  Â  Â  Â  Â  Â  Â  Â  margin-bottom: 5px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /* 5. Ğ˜Ğ¡Ğ¢ĞĞ Ğ˜Ğ¯ (Ğ¡ĞµÑ€Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº Ğ²Ğ½Ğ¸Ğ·Ñƒ) */
Â  Â  Â  Â  Â  Â  td:nth-of-type(5) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 0.85em;Â 
Â  Â  Â  Â  Â  Â  Â  Â  color: #555;Â 
Â  Â  Â  Â  Â  Â  Â  Â  background: rgba(255,255,255,0.5);Â 
Â  Â  Â  Â  Â  Â  Â  Â  padding: 8px;Â 
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 4px;Â 
Â  Â  Â  Â  Â  Â  Â  Â  min-height: 30px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /* 6. Ğ£Ğ”ĞĞ›Ğ•ĞĞ˜Ğ•/Ğ‘ĞĞ (ĞĞ±ÑĞ¾Ğ»ÑÑ‚Ğ½Ğ¾ Ğ² Ğ¿Ñ€Ğ°Ğ²Ğ¾Ğ¼ Ğ²ĞµÑ€Ñ…Ğ½ĞµĞ¼ ÑƒĞ³Ğ»Ñƒ) */
Â  Â  Â  Â  Â  Â  td:nth-of-type(6) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  position: absolute;Â 
Â  Â  Â  Â  Â  Â  Â  Â  top: 15px;Â 
Â  Â  Â  Â  Â  Â  Â  Â  right: 10px;Â 
Â  Â  Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  Â  Â  gap: 5px;Â 
Â  Â  Â  Â  Â  Â  Â  Â  padding: 0;Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  .btn-reset-player, .btn-delete, .btn-ban {Â 
Â  Â  Â  Â  Â  Â  Â  Â  width: 34px;Â 
Â  Â  Â  Â  Â  Â  Â  Â  height: 34px;Â 
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1em;Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /* ĞŸĞ¾Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Ğ¸Ñ‚Ğ¾Ğ³Ğ° Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ğ¾Ğº */
Â  Â  Â  Â  Â  Â  .grand-total-panel {Â 
Â  Â  Â  Â  Â  Â  Â  Â  flex-direction: column;Â 
Â  Â  Â  Â  Â  Â  Â  Â  text-align: center;Â 
Â  Â  Â  Â  Â  Â  Â  Â  gap: 5px;Â 
Â  Â  Â  Â  Â  Â  Â  Â  padding: 15px;Â 
Â  Â  Â  Â  Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  Â  Â  Â  Â  box-sizing: border-box;Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  .gt-label { font-size: 1.2em; }
Â  Â  Â  Â  Â  Â  .gt-value { font-size: 3em; line-height: 1; }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  .close-menu-btn { display: block; }
Â  Â  Â  Â  Â  Â  tfoot { display: none; }
Â  Â  Â  Â  }
Â  Â  Â  Â  /* --- Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ Ğ ĞĞĞ“ĞĞ’ --- */
Â  Â  Â  Â  .role-hidden { display: none !important; }

Â  Â  Â  Â  .role-badge {
Â  Â  Â  Â  Â  Â  font-size: 1.2em;
Â  Â  Â  Â  Â  Â  margin-right: 5px;
Â  Â  Â  Â  Â  Â  cursor: help;
Â  Â  Â  Â  Â  Â  text-shadow: 1px 1px 0 rgba(0,0,0,0.3);
Â  Â  Â  Â  }

Â  Â  Â  Â Â 

Â  Â  Â  Â  /* Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸Ğº Ğ²Ğ¸Ğ´Ğ¸Ñ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‚ĞµĞºÑÑ‚, Ğ½Ğµ Ğ²Ğ¸Ğ´Ğ¸Ñ‚ inputs */
Â  Â  Â  Â  .view-only-input {
Â  Â  Â  Â  Â  Â  border: none !important;
Â  Â  Â  Â  Â  Â  background: transparent !important;
Â  Â  Â  Â  Â  Â  pointer-events: none; /* Ğ—Ğ°Ğ¿Ñ€ĞµÑ‚ ĞºĞ»Ğ¸ĞºĞ° */
Â  Â  Â  Â  Â  Â  color: var(--ink-color) !important;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* --- ĞœĞĞ”ĞĞ›Ğ¬ĞĞĞ• ĞĞšĞĞ Ğ ĞĞ›Ğ•Ğ™ --- */
Â  Â  Â  Â  .modal-overlay {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 0; left: 0; width: 100%; height: 100%;
Â  Â  Â  Â  Â  Â  background: rgba(0, 0, 0, 0.85);
Â  Â  Â  Â  Â  Â  z-index: 5000; /* Ğ¡Ğ°Ğ¼Ñ‹Ğ¹ Ğ²ĞµÑ€Ñ…Ğ½Ğ¸Ğ¹ ÑĞ»Ğ¾Ğ¹ */
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(2px);
Â  Â  Â  Â  }

Â  Â  Â  Â  .modal-card {
Â  Â  Â  Â  Â  Â  background-image: var(--paper-texture);
Â  Â  Â  Â  Â  Â  background-color: var(--paper-bg);
Â  Â  Â  Â  Â  Â  border: 4px double var(--accent-brown);
Â  Â  Â  Â  Â  Â  padding: 25px;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  width: 90%;
Â  Â  Â  Â  Â  Â  max-width: 320px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 20px rgba(0,0,0,0.8);
Â  Â  Â  Â  }

Â  Â  Â  Â  .role-buttons-list {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .role-select-btn {
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  font-family: 'Rye', cursive;
Â  Â  Â  Â  Â  Â  font-size: 1.1em;
Â  Â  Â  Â  Â  Â  border: 2px solid rgba(0,0,0,0.2);
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  text-shadow: 1px 1px 0 #000;
Â  Â  Â  Â  }

Â  Â  Â  Â  .btn-admin { background-color: #b71c1c; border-color: #7f0000; }
Â  Â  Â  Â  .btn-trusted { background-color: #0277bd; border-color: #01579b; }
Â  Â  Â  Â  .btn-player { background-color: #2e7d32; border-color: #1b5e20; }

Â  Â  Â  Â  .btn-cancel-role {
Â  Â  Â  Â  Â  Â  background: transparent;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  text-decoration: underline;
Â  Â  Â  Â  Â  Â  color: var(--accent-brown);
Â  Â  Â  Â  Â  Â  font-family: 'Special Elite', monospace;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-size: 1.1em;
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>

<div id="login-overlay">
Â  Â  <div id="login-view-card" class="login-card">
Â  Â  Â  Â  <h2>Ğ’Ğ¥ĞĞ” Ğ’ ĞšĞ›Ğ£Ğ‘</h2>
Â  Â  Â  Â  <div class="brand-container" style="border:none; margin:0; padding:0;">
Â  Â  Â  Â  Â  Â  Â <img src="./logo.png" class="header-logo-round" style="margin-bottom:15px; width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #8b4513;">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <input type="text" id="loginNick" class="login-input" placeholder="ĞĞ¸ĞºĞ½ĞµĞ¹Ğ¼">
Â  Â  Â  Â  <input type="password" id="loginPass" class="login-input" placeholder="ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ">
Â  Â  Â  Â  <div class="login-checkbox">
Â  Â  Â  Â  Â  Â  <input type="checkbox" id="rememberMe" style="width:auto;">
Â  Â  Â  Â  Â  Â  <label for="rememberMe">Ğ—Ğ°Ğ¿Ğ¾Ğ¼Ğ½Ğ¸Ñ‚ÑŒ Ğ¼ĞµĞ½Ñ</label>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button class="btn-login-action" onclick="handleLogin()">Ğ’ĞĞ™Ğ¢Ğ˜</button>
Â  Â  Â  Â  <button class="btn-register-link" onclick="switchAuthView('register')">ĞĞµÑ‚ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°? Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ</button>
Â  Â  Â  Â  <div id="loginError" class="error-msg"></div>
Â  Â  </div>
Â  Â  <div id="register-view-card" class="login-card hidden">
Â  Â  Â  Â  <h2>Ğ Ğ•Ğ“Ğ˜Ğ¡Ğ¢Ğ ĞĞ¦Ğ˜Ğ¯</h2>
Â  Â  Â  Â  <input type="text" id="regNick" class="login-input" placeholder="ĞŸÑ€Ğ¸Ğ´ÑƒĞ¼Ğ°Ğ¹Ñ‚Ğµ ĞĞ¸Ğº">
Â  Â  Â  Â  <input type="password" id="regPass" class="login-input" placeholder="ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ">
Â  Â  Â  Â  <input type="password" id="regPassRepeat" class="login-input" placeholder="ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ">
Â  Â  Â  Â  <button class="btn-login-action btn-register" onclick="handleRegister()">Ğ¡ĞĞ—Ğ”ĞĞ¢Ğ¬ ĞĞšĞšĞĞ£ĞĞ¢</button>
Â  Â  Â  Â  <button class="btn-login-action btn-back" onclick="switchAuthView('login')">ĞĞĞ—ĞĞ”</button>
Â  Â  Â  Â  <div id="regError" class="error-msg"></div>
Â  Â  </div>
</div>

<div id="networkStatus" class="network-badge status-offline" style="display:none;">â³</div>

<button class="menu-toggle" onclick="toggleSidebar()">
Â  Â  â˜° <span id="mobileStatusDot" class="status-dot"></span>
</button>

<div class="sidebar" id="sidebar">
Â  Â  <button class="close-menu-btn" onclick="toggleSidebar()">âœ•</button>
Â  Â  <div class="sidebar-logo">
Â  Â  Â  Â  <img src="./logo.png" alt="Ğ›Ğ¾Ğ³Ğ¾">
Â  Â  Â  Â  <div class="user-info-container">
Â  Â  Â  Â  Â  Â  <div class="display-name-row">
Â  Â  Â  Â  Â  Â  Â  Â  <span id="menuDisplayName">Ğ“Ğ¾ÑÑ‚ÑŒ</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="edit-icon" onclick="editNickname()">âœï¸</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span id="desktopStatusDot" class="status-dot"></span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="login-name-row" id="menuLoginName">@...</div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <button id="btn-nav-game" class="nav-btn active" onclick="showView('game')">ğŸ² Ğ˜Ğ³Ñ€Ğ¾Ğ²Ğ¾Ğ¹ ÑÑ‚Ğ¾Ğ»</button>
Â  Â  <button id="btn-nav-chat" class="nav-btn" onclick="showView('chat')">
Â  Â  ğŸ’¬ Ğ§Ğ°Ñ‚ <span id="chatBadge" class="notification-badge">0</span>
Â  Â  </button>
Â  Â  <button id="btn-nav-journal" class="nav-btn" onclick="showView('journal')">ğŸ“œ Ğ–ÑƒÑ€Ğ½Ğ°Ğ» Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ°</button>
Â  Â Â 
Â  Â  <button class="nav-btn" onclick="logout()" style="margin-top: 20px;">ğŸšª Ğ’Ğ«Ğ™Ğ¢Ğ˜</button>
Â  Â Â 
Â  Â  <button class="btn-extreme-reset" onclick="extremeReset()">â˜¢ï¸ Ğ¡Ğ‘Ğ ĞĞ¡Ğ˜Ğ¢Ğ¬ Ğ’Ğ¡Ğ</button>
</div>

<div class="main-content">
Â  Â  <div id="view-game">
Â  Â  Â  Â  <div class="brand-container">
Â  Â  Â  Â  Â  Â  <h1 class="header-title">Ğ˜Ğ³Ğ¾Ñ€Ğ½Ñ‹Ğ¹ ĞºĞ»ÑƒĞ± "Ğ¡Ğ¾Ğ·Ğ²ĞµĞ·Ğ´Ğ¸Ğµ Ğ¾Ñ€Ğ»Ğ°"</h1>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="center-wrap">
Â  Â  Â  Â  Â  Â  <div id="onlineCounter" class="online-counter">ğŸ‘ï¸ ĞĞ½Ğ»Ğ°Ğ¹Ğ½: ...</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="date-section">
Â  Â  Â  Â  Â  Â  <label>ğŸ“… Ğ”Ğ°Ñ‚Ğ° Ğ¸Ğ³Ñ€Ñ‹:</label>
Â  Â  Â  Â  Â  Â  <input type="date" id="gameDate">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="controls">
Â  Â  Â  Â  Â  Â  <button class="btn-add" onclick="createNewPlayer()">+ Ğ˜Ğ³Ñ€Ğ¾Ğº</button>
Â  Â  Â  Â  Â  Â  <button class="btn-newday" onclick="startNewDay()">ğŸŒ… ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ</button>
Â  Â  Â  Â  Â  Â  <button class="btn-journal-add" onclick="addToJournal()">ğŸ’¾ Ğ’ Ğ–ÑƒÑ€Ğ½Ğ°Ğ»</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <table id="scoreTable">
Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="width: 20%;">Ğ˜Ğ¼Ñ</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="width: 15%;">Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</th> <th style="width: 25%;">Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="width: 10%;">Ğ˜Ñ‚Ğ¾Ğ³</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="width: 25%;">Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="width: 5%;"></th>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  <tbody id="tableBody"></tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="grand-total-panel">
Â  Â  Â  Â  Â  Â  <div class="gt-label">ĞĞ‘Ğ©Ğ˜Ğ™ Ğ‘ĞĞĞš</div>
Â  Â  Â  Â  Â  Â  <div id="grandTotal" class="gt-value">0</div>
Â  Â  Â  Â  </div>

Â  Â  </div>

Â  Â  <div id="view-chat" class="hidden chat-wrapper">
Â  Â  Â  Â  <div class="brand-container">
Â  Â  Â  Â  Â  Â  <h1 class="header-title">ĞšĞ¾Ğ¼Ğ½Ğ°Ñ‚Ğ° Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ</h1>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="privateChatHeader" class="chat-header-private hidden">
Â  Â  Â  Â  Â  Â  <span id="privateChatTitle">Ğ›Ğ¸Ñ‡ĞºĞ° Ñ ...</span>
Â  Â  Â  Â  Â  Â  <button class="btn-back-general" onclick="openGeneralChat()">â¬… Ğ’ ĞĞ±Ñ‰Ğ¸Ğ¹</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="chatMessages" class="chat-messages"></div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="chat-input-bar">
Â  Â  Â  Â  Â  Â  <button id="btnCancelEdit" class="btn-delete hidden" style="border-radius: 4px; margin-right:5px; width:40px;" onclick="cancelEditMode()" title="ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ">âœ•</button>
Â  Â  Â  Â  Â  Â  <input type="text" id="chatInput" class="chat-input" placeholder="ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ...">
Â  Â  Â  Â  Â  Â  <button id="btnSendChat" class="btn-send" onclick="sendMessage()">â¤</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="view-journal" class="hidden">
Â  Â  Â  Â  <div class="brand-container">
Â  Â  Â  Â  Â  Â  <h1 class="header-title">ĞÑ€Ñ…Ğ¸Ğ² Ğ–ÑƒÑ€Ğ½Ğ°Ğ»Ğ°</h1>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="journalList" class="journal-list">
Â  Â  Â  Â  Â  Â  <div style="text-align:center;">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ°...</div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="version-tag" onclick="forceUpdate()">OrelPoker v74.0 (Final)</div>
Â  Â Â 
Â  Â  <div id="roleModal" class="modal-overlay role-hidden">
Â  Â  Â  Â  <div class="modal-card">
Â  Â  Â  Â  Â  Â  <h3 style="margin-top:0; color:#8b4513; font-family:'Rye', cursive;">ĞĞĞ—ĞĞĞ§Ğ˜Ğ¢Ğ¬ Ğ ĞĞ›Ğ¬</h3>
Â  Â  Â  Â  Â  Â  <p id="roleTargetName" style="font-weight:bold; font-size:1.2em; margin-bottom:15px;">...</p>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="role-buttons-list">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="role-select-btn btn-admin" onclick="setRole('admin')">ğŸ‘‘ ĞĞ”ĞœĞ˜Ğ</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="role-select-btn btn-trusted" onclick="setRole('trusted')">ğŸ›¡ï¸ Ğ”ĞĞ’Ğ•Ğ Ğ•ĞĞĞĞ• Ğ›Ğ˜Ğ¦Ğ</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="role-select-btn btn-player" onclick="setRole('player')">ğŸ‘¤ Ğ˜Ğ“Ğ ĞĞš</button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <button class="btn-cancel-role" onclick="closeRoleModal()">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<script>
Â  Â  window.forceUpdate = async function() {
Â  Â  Â  Â  if (!confirm("ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ?")) return;
Â  Â  Â  Â  if ('serviceWorker' in navigator) {
Â  Â  Â  Â  Â  Â  const registrations = await navigator.serviceWorker.getRegistrations();
Â  Â  Â  Â  Â  Â  for (let registration of registrations) { await registration.unregister(); }
Â  Â  Â  Â  }
Â  Â  Â  Â  caches.keys().then(async function(names) {
Â  Â  Â  Â  Â  Â  await Promise.all(names.map(name => caches.delete(name)));
Â  Â  Â  Â  Â  Â  window.location.reload(true);
Â  Â  Â  Â  });
Â  Â  }

Â  Â  if ('serviceWorker' in navigator) {
Â  Â  Â  Â  window.addEventListener('load', () => {
Â  Â  Â  Â  Â  Â  navigator.serviceWorker.register('./sw.js?v=74').then(reg => {
Â  Â  Â  Â  Â  Â  Â  Â  reg.update();
Â  Â  Â  Â  Â  Â  Â  Â  reg.onupdatefound = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newWorker = reg.installing;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newWorker.onstatechange = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.location.reload();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  navigator.serviceWorker.addEventListener('controllerchange', () => window.location.reload());
Â  Â  Â  Â  });
Â  Â  }
</script>

<script type="module">
Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
Â  Â  import { getDatabase, ref, onValue, push, set, remove, update, get, query, limitToLast, orderByKey, runTransaction, onDisconnect, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

Â  Â  const firebaseConfig = {
Â  Â  Â  Â  apiKey: "AIzaSyD9E8XsdjGx275Es6HwdCo5jy2l0kJoNXg",
Â  Â  Â  Â  authDomain: "orelpoker-cd9d4.firebaseapp.com",
Â  Â  Â  Â  databaseURL: "https://orelpoker-cd9d4-default-rtdb.firebaseio.com",
Â  Â  Â  Â  projectId: "orelpoker-cd9d4",
Â  Â  Â  Â  storageBucket: "orelpoker-cd9d4.firebasestorage.app",
Â  Â  Â  Â  messagingSenderId: "913271365234",
Â  Â  Â  Â  appId: "1:913271365234:web:b48f717e011eea4847eceb"
Â  Â  };

Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  const db = getDatabase(app);
Â  Â  const playersRef = ref(db, 'players');
Â  Â  const journalRef = ref(db, 'journal');
Â  Â  const usersRef = ref(db, 'users');
Â  Â  const chatRef = ref(db, 'chat');
Â  Â  const connectedRef = ref(db, ".info/connected");
Â  Â  const onlineUsersRef = ref(db, "online_users");
Â  Â  let currentConnectionRef = null;
Â  Â  let onlineNicknames = new Set();

Â  Â  // --- Ğ’Ğ¡ĞŸĞĞœĞĞ“ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ«Ğ• Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜ ---
Â  Â  function updateMenuUI(displayName, loginName) {
Â  Â  Â  Â  const nameEl = document.getElementById('menuDisplayName');
Â  Â  Â  Â  const loginEl = document.getElementById('menuLoginName');
Â  Â  Â  Â  if (nameEl) nameEl.innerText = displayName || "Ğ“Ğ¾ÑÑ‚ÑŒ";
Â  Â  Â  Â  if (loginEl) loginEl.innerText = loginName ? "@" + loginName : "@...";
Â  Â  }

Â  Â  function addEnterTrigger(inputId, actionFunction) {
Â  Â  Â  Â  const input = document.getElementById(inputId);
Â  Â  Â  Â  if (input) {
Â  Â  Â  Â  Â  Â  input.addEventListener('keypress', function(event) {
Â  Â  Â  Â  Â  Â  Â  Â  if (event.key === 'Enter') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actionFunction();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  // --- Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯ ---
Â  Â  document.addEventListener("DOMContentLoaded", () => {
Â  Â  Â  Â  addEnterTrigger('chatInput', sendMessage);
Â  Â  Â  Â  addEnterTrigger('loginNick', handleLogin);
Â  Â  Â  Â  addEnterTrigger('loginPass', handleLogin);
Â  Â  Â  Â  addEnterTrigger('regNick', handleRegister);
Â  Â  Â  Â  addEnterTrigger('regPass', handleRegister);
Â  Â  Â  Â  addEnterTrigger('regPassRepeat', handleRegister);

Â  Â  Â  Â  // Ğ”Ğ°Ñ‚Ğ°
Â  Â  Â  Â  const dateField = document.getElementById('gameDate');
Â  Â  Â  Â  if (dateField) {
Â  Â  Â  Â  Â  Â  const today = new Date();
Â  Â  Â  Â  Â  Â  const yyyy = today.getFullYear();
Â  Â  Â  Â  Â  Â  const mm = String(today.getMonth() + 1).padStart(2, '0');
Â  Â  Â  Â  Â  Â  const dd = String(today.getDate()).padStart(2, '0');
Â  Â  Â  Â  Â  Â  dateField.value = `${yyyy}-${mm}-${dd}`;
Â  Â  Â  Â  }

Â  Â  Â  Â  // ĞĞ²Ñ‚Ğ¾-Ğ²Ñ…Ğ¾Ğ´ (ĞÑ„Ğ»Ğ°Ğ¹Ğ½/ĞĞ½Ğ»Ğ°Ğ¹Ğ½)
Â  Â  Â  Â  const savedUser = localStorage.getItem('op_user');
Â  Â  Â  Â  if(savedUser) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const user = JSON.parse(savedUser);
Â  Â  Â  Â  Â  Â  Â  Â  if (user.nick && user.pass) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  checkLogin(user.nick, user.pass, true, true);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch(e) { console.error("Cache error", e); }
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const sessionUser = sessionStorage.getItem('op_session_user');
Â  Â  Â  Â  if(sessionUser) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const user = JSON.parse(sessionUser);
Â  Â  Â  Â  Â  Â  Â  Â  checkLogin(user.nick, user.pass, true, false);
Â  Â  Â  Â  Â  Â  } catch(e) {}
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(navigator.onLine) syncUsersToTable();
Â  Â  Â  Â  openGeneralChat(); // ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ÑÑ Ğº Ğ¾Ğ±Ñ‰ĞµĞ¼Ñƒ Ñ‡Ğ°Ñ‚Ñƒ Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ğµ
Â  Â  });

Â  Â  // =========================================================
Â  Â  // ĞĞĞ’ĞĞ¯ Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ Ğ§ĞĞ¢ĞĞ’ (ĞĞ‘Ğ©Ğ˜Ğ™ + Ğ›Ğ˜Ğ§ĞšĞ)
Â  Â  // =========================================================
Â  Â Â 
Â  Â  let currentChatId = 'general'; // 'general' Ğ¸Ğ»Ğ¸ 'private_nick1_nick2'
Â  Â  let chatListener = null;Â  Â  Â  Â // Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ½Ğ° ÑĞ»ÑƒÑˆĞ°Ñ‚ĞµĞ»ÑŒ Ğ±Ğ°Ğ·Ñ‹ (Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ñ‚ĞºĞ»ÑÑ‡Ğ°Ñ‚ÑŒ)
Â  Â  let editingMsgId = null;
Â  Â Â 
Â  Â  // 1. Ğ—ĞĞŸĞ£Ğ¡Ğš Ğ§ĞĞ¢Ğ (Ğ¡Ğ¼ĞµĞ½Ğ° ĞºĞ¾Ğ¼Ğ½Ğ°Ñ‚Ñ‹)
Â  Â  window.loadChat = function(chatId, title) {
Â  Â  Â  Â  // ĞÑ‚ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¹ ÑĞ»ÑƒÑˆĞ°Ñ‚ĞµĞ»ÑŒ, ĞµÑĞ»Ğ¸ Ğ±Ñ‹Ğ»
Â  Â  Â  Â  if (chatListener) {
Â  Â  Â  Â  Â  Â  // Firebase ÑĞ°Ğ¼ Ğ½Ğµ Ğ´Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ³Ğ¾ off, Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ¼Ñƒ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¾Ñ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€
Â  Â  Â  Â  Â  Â  // Ğ’ Ğ¸Ğ´ĞµĞ°Ğ»Ğµ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑŒ ref Ğ¸ Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ off(), Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ñ‚Ñ‹ Ğ¿ĞµÑ€ĞµÑ€Ğ¸ÑÑƒĞµĞ¼
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  currentChatId = chatId;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // UI Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
Â  Â  Â  Â  const header = document.getElementById('privateChatHeader');
Â  Â  Â  Â  const titleEl = document.getElementById('privateChatTitle');
Â  Â  Â  Â  const container = document.getElementById('chatMessages');
Â  Â  Â  Â Â 
Â  Â  Â  Â  container.innerHTML = '<div style="text-align:center; padding:20px;">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ‡Ğ°Ñ‚Ğ°...</div>';

Â  Â  Â  Â  if (chatId === 'general') {
Â  Â  Â  Â  Â  Â  header.classList.add('hidden');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  header.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  titleEl.innerText = title || "Ğ›Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ñ‡Ğ°Ñ‚";
Â  Â  Â  Â  }

Â  Â  Â  Â  // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¿ÑƒÑ‚ÑŒ Ğ² Ğ±Ğ°Ğ·Ğµ
Â  Â  Â  Â  // Ğ•ÑĞ»Ğ¸ Ğ¾Ğ±Ñ‰Ğ¸Ğ¹ - Ğ¿ÑƒÑ‚ÑŒ 'chat', ĞµÑĞ»Ğ¸ Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ - 'private_chats/chatId'
Â  Â  Â  Â  const path = chatId === 'general' ? 'chat' : `private_chats/${chatId}`;
Â  Â  Â  Â  const targetRef = ref(db, path);

Â  Â  Â  Â  // Ğ’ĞµÑˆĞ°ĞµĞ¼ ÑĞ»ÑƒÑˆĞ°Ñ‚ĞµĞ»ÑŒ
Â  Â  Â  Â  onValue(targetRef, (snapshot) => {
Â  Â  Â  Â  Â  Â  renderChatMessages(snapshot);
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ğ²Ğ¸Ğ´
Â  Â  Â  Â  showView('chat');
Â  Â  }

Â  Â  window.openGeneralChat = function() {
Â  Â  Â  Â  loadChat('general');
Â  Â  }

Â  Â  window.openPrivateChat = function(targetLogin) {
Â  Â  Â  Â  const sessionUser = JSON.parse(sessionStorage.getItem('op_session_user'));
Â  Â  Â  Â  if (!sessionUser) return;
Â  Â  Â  Â  const myLogin = sessionUser.nick;

Â  Â  Â  Â  if (targetLogin === myLogin) { alert("ĞĞµĞ»ÑŒĞ·Ñ Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ ÑĞ°Ğ¼Ğ¾Ğ¼Ñƒ ÑĞµĞ±Ğµ!"); return; }

Â  Â  Â  Â  // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ID Ñ‡Ğ°Ñ‚Ğ° (ÑĞ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ¸ĞºĞ¸ Ğ¿Ğ¾ Ğ°Ğ»Ñ„Ğ°Ğ²Ğ¸Ñ‚Ñƒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ñƒ Ğ¾Ğ±Ğ¾Ğ¸Ñ… Ğ±Ñ‹Ğ» Ğ¾Ğ´Ğ¸Ğ½ ID)
Â  Â  Â  Â  // ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: admin Ğ¸ guest -> admin_guest
Â  Â  Â  Â  const participants = [myLogin, targetLogin].sort();
Â  Â  Â  Â  const chatId = participants.join('_');
Â  Â  Â  Â Â 
Â  Â  Â  Â  loadChat(chatId, `Ğ›Ğ¸Ñ‡ĞºĞ° Ñ @${targetLogin}`);
Â  Â  }

Â  Â  // 2. ĞĞ¢ĞŸĞ ĞĞ’ĞšĞ Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ¯
Â  Â  window.sendMessage = function() {
Â  Â  Â  Â  const input = document.getElementById('chatInput');
Â  Â  Â  Â  const text = input.value.trim();
Â  Â  Â  Â  if (!text) return;

Â  Â  Â  Â  const nameEl = document.getElementById('menuDisplayName');
Â  Â  Â  Â  const senderName = nameEl ? nameEl.innerText : "Ğ“Ğ¾ÑÑ‚ÑŒ";
Â  Â  Â  Â  const sessionUser = JSON.parse(sessionStorage.getItem('op_session_user')) || {};
Â  Â  Â  Â  const userLogin = sessionUser.nick || "anon";

Â  Â  Â  Â  // ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ ĞºÑƒĞ´Ğ° Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ
Â  Â  Â  Â  const path = currentChatId === 'general' ? 'chat' : `private_chats/${currentChatId}`;

Â  Â  Â  Â  if (editingMsgId) {
Â  Â  Â  Â  Â  Â  update(ref(db, `${path}/${editingMsgId}`), {
Â  Â  Â  Â  Â  Â  Â  Â  text: text,
Â  Â  Â  Â  Â  Â  Â  Â  isEdited: true
Â  Â  Â  Â  Â  Â  }).then(() => cancelEditMode());
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  push(ref(db, path), {
Â  Â  Â  Â  Â  Â  Â  Â  sender: senderName,
Â  Â  Â  Â  Â  Â  Â  Â  senderLogin: userLogin,
Â  Â  Â  Â  Â  Â  Â  Â  text: text,
Â  Â  Â  Â  Â  Â  Â  Â  timestamp: Date.now()
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  input.value = '';
Â  Â  Â  Â  input.focus();
Â  Â  }

Â  Â  // 3. ĞĞ¢Ğ Ğ˜Ğ¡ĞĞ’ĞšĞ Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ™
Â  Â  function renderChatMessages(snapshot) {
Â  Â  Â  Â  const container = document.getElementById('chatMessages');
Â  Â  Â  Â  container.innerHTML = '';
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!snapshot.exists()) {
Â  Â  Â  Â  Â  Â  container.innerHTML = '<div style="text-align:center; opacity:0.5; margin-top:20px;">Ğ—Ğ´ĞµÑÑŒ Ğ¿Ğ¾ĞºĞ° Ğ¿ÑƒÑÑ‚Ğ¾...</div>';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const messages = [];
Â  Â  Â  Â  snapshot.forEach(child => {
Â  Â  Â  Â  Â  Â  messages.push({ key: child.key, ...child.val() });
Â  Â  Â  Â  });
Â  Â  Â  Â  messages.sort((a, b) => a.timestamp - b.timestamp);

Â  Â  Â  Â  const sessionUser = JSON.parse(sessionStorage.getItem('op_session_user')) || {};
Â  Â  Â  Â  const myLogin = sessionUser.nick;
Â  Â  Â  Â  const now = Date.now();
Â  Â  Â  Â  const oneDay = 24 * 60 * 60 * 1000;

Â  Â  Â  Â  messages.forEach(msg => {
Â  Â  Â  Â  Â  Â  const bubble = document.createElement('div');
Â  Â  Â  Â  Â  Â  const isMine = (msg.senderLogin === myLogin);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const d = new Date(msg.timestamp);
Â  Â  Â  Â  Â  Â  const dateStr = d.toLocaleDateString() === new Date().toLocaleDateString()Â 
Â  Â  Â  Â  Â  Â  Â  Â  ? d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
Â  Â  Â  Â  Â  Â  Â  Â  : d.toLocaleString([], {day: 'numeric', month:'numeric', hour: '2-digit', minute:'2-digit'});

Â  Â  Â  Â  Â  Â  bubble.className = `message-bubble ${isMine ? 'my-message' : 'other-message'}`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let actionsHtml = '';
Â  Â  Â  Â  Â  Â  if (isMine && (now - msg.timestamp < oneDay)) {
Â  Â  Â  Â  Â  Â  Â  Â  const safeText = msg.text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
Â  Â  Â  Â  Â  Â  Â  Â  actionsHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  <span class="msg-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="msg-btn" onclick="startEditMessage('${msg.key}', '${safeText}', ${msg.timestamp})">âœï¸</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="msg-btn" onclick="deleteChatMessage('${msg.key}', ${msg.timestamp})">ğŸ—‘</button>
Â  Â  Â  Â  Â  Â  Â  Â  </span>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const editedMark = msg.isEdited ? `<span class="edited-label">(Ñ€ĞµĞ´.)</span>` : '';

Â  Â  Â  Â  Â  Â  bubble.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:baseline;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="message-sender">${msg.sender}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="msg-meta">${dateStr}</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div>${msg.text} ${editedMark} ${actionsHtml}</div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  container.appendChild(bubble);
Â  Â  Â  Â  });
Â  Â  Â  Â  container.scrollTop = container.scrollHeight;
Â  Â  }

Â  Â  // Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ñ‡Ğ°Ñ‚Ğ°
Â  Â  window.startEditMessage = function(key, oldText, timestamp) {
Â  Â  Â  Â  if (Date.now() - timestamp > 86400000) { alert("Ğ’Ñ€ĞµĞ¼Ñ Ğ²Ñ‹ÑˆĞ»Ğ¾."); return; }
Â  Â  Â  Â  const input = document.getElementById('chatInput');
Â  Â  Â  Â  editingMsgId = key;
Â  Â  Â  Â  input.value = oldText;
Â  Â  Â  Â  input.focus();
Â  Â  Â  Â  input.classList.add('editing-mode');
Â  Â  Â  Â  document.getElementById('btnSendChat').innerText = "ğŸ’¾";
Â  Â  Â  Â  document.getElementById('btnCancelEdit').classList.remove('hidden');
Â  Â  }

Â  Â  window.cancelEditMode = function() {
Â  Â  Â  Â  const input = document.getElementById('chatInput');
Â  Â  Â  Â  editingMsgId = null;
Â  Â  Â  Â  input.value = '';
Â  Â  Â  Â  input.classList.remove('editing-mode');
Â  Â  Â  Â  document.getElementById('btnSendChat').innerText = "â¤";
Â  Â  Â  Â  document.getElementById('btnCancelEdit').classList.add('hidden');
Â  Â  }

Â  Â  window.deleteChatMessage = function(key, timestamp) {
Â  Â  Â  Â  if (Date.now() - timestamp > 86400000) { alert("Ğ’Ñ€ĞµĞ¼Ñ Ğ²Ñ‹ÑˆĞ»Ğ¾."); return; }
Â  Â  Â  Â  if (confirm("Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ?")) {
Â  Â  Â  Â  Â  Â  const path = currentChatId === 'general' ? 'chat' : `private_chats/${currentChatId}`;
Â  Â  Â  Â  Â  Â  remove(ref(db, `${path}/${key}`));
Â  Â  Â  Â  Â  Â  if (editingMsgId === key) cancelEditMode();
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // =========================================================
Â  Â  // ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞĞĞ¯ Ğ¢ĞĞ‘Ğ›Ğ˜Ğ¦Ğ (Ğ¡ ĞºĞ½Ğ¾Ğ¿ĞºĞ¾Ğ¹ Ğ›Ğ¡)
Â  Â  // =========================================================

Â  Â  function renderPlayerRow(id, player) {
Â  Â  Â  Â  const sessionUser = JSON.parse(sessionStorage.getItem('op_session_user')) || { role: 'player' };
Â  Â  Â  Â  const myRole = sessionUser.role;
Â  Â  Â  Â  const myLogin = sessionUser.nick; // Ğ”Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ "Ğ½Ğµ Ñ Ğ»Ğ¸ ÑÑ‚Ğ¾"

Â  Â  Â  Â  const tableBody = document.getElementById('tableBody');
Â  Â  Â  Â  const newRow = tableBody.insertRow();
Â  Â  Â  Â  const { total, historyArray } = calculatePlayerStats(player);

Â  Â  Â  Â  // 1. Ğ˜ĞœĞ¯
Â  Â  Â  Â  const cellName = newRow.insertCell(0);
Â  Â  Â  Â  const nameWrapper = document.createElement('div');
Â  Â  Â  Â  nameWrapper.className = 'name-wrapper';
Â  Â  Â  Â Â 
Â  Â  Â  Â  const statusDot = document.createElement('div');
Â  Â  Â  Â  statusDot.className = 'player-status-indicator';
Â  Â  Â  Â  if(player.login) statusDot.setAttribute('data-player-login', player.login);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- ĞšĞĞĞŸĞšĞ Ğ›Ğ˜Ğ§ĞšĞ˜ (ĞĞĞ’ĞĞ•) ---
Â  Â  Â  Â  // Ğ•ÑĞ»Ğ¸ Ğ¸Ğ³Ñ€Ğ¾Ğº Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ (ĞµÑÑ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸Ğ½) Ğ¸ ÑÑ‚Ğ¾ Ğ½Ğµ Ñ ÑĞ°Ğ¼
Â  Â  Â  Â  if (player.login && player.login !== myLogin) {
Â  Â  Â  Â  Â  Â  const btnDM = document.createElement('span');
Â  Â  Â  Â  Â  Â  btnDM.innerText = 'âœ‰ï¸';
Â  Â  Â  Â  Â  Â  btnDM.className = 'btn-start-dm';
Â  Â  Â  Â  Â  Â  btnDM.title = 'ĞĞ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ';
Â  Â  Â  Â  Â  Â  btnDM.onclick = () => openPrivateChat(player.login);
Â  Â  Â  Â  Â  Â  nameWrapper.appendChild(btnDM);
Â  Â  Â  Â  }

Â  Â  Â  Â  const roleBadge = document.createElement('span');
Â  Â  Â  Â  roleBadge.className = 'role-badge';
Â  Â  Â  Â  if (!player.login) { roleBadge.innerText = 'ğŸ‘½'; roleBadge.title = 'Ğ“Ğ¾ÑÑ‚ÑŒ'; }Â 
Â  Â  Â  Â  else if (player.login === 'Zagonskiy') { roleBadge.innerText = 'ğŸ‘‘'; roleBadge.title = 'Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ĞµĞ»ÑŒ'; }
Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  roleBadge.innerText = 'â³';
Â  Â  Â  Â  Â  Â  get(child(ref(db), 'users/' + player.login + '/role')).then((snap) => {
Â  Â  Â  Â  Â  Â  Â  Â  const r = snap.val();
Â  Â  Â  Â  Â  Â  Â  Â  if (r === 'admin') { roleBadge.innerText = 'ğŸ‘‘'; roleBadge.title = 'ĞĞ´Ğ¼Ğ¸Ğ½'; }
Â  Â  Â  Â  Â  Â  Â  Â  else if (r === 'trusted') { roleBadge.innerText = 'ğŸ›¡ï¸'; roleBadge.title = 'Ğ”Ğ¾Ğ²ĞµÑ€ĞµĞ½Ğ½Ñ‹Ğ¹'; }
Â  Â  Â  Â  Â  Â  Â  Â  else { roleBadge.innerText = 'ğŸ‘¤'; roleBadge.title = 'Ğ˜Ğ³Ñ€Ğ¾Ğº'; }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  const inputName = document.createElement('input');
Â  Â  Â  Â  inputName.type = 'text';Â 
Â  Â  Â  Â  inputName.className = 'player-name';Â 
Â  Â  Â  Â  inputName.value = player.name || "";
Â  Â  Â  Â  inputName.readOnly = true;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ĞšĞ›Ğ˜ĞšĞ˜ (Ğ¡Ğ¼ĞµĞ½Ğ° Ñ€Ğ°Ğ½Ğ³Ğ°/Ğ¸Ğ¼ĞµĞ½Ğ¸)
Â  Â  Â  Â  if (myRole === 'admin' && player.login) {
Â  Â  Â  Â  Â  Â  inputName.style.cursor = "pointer";
Â  Â  Â  Â  Â  Â  inputName.style.textDecoration = "underline";
Â  Â  Â  Â  Â  Â  inputName.onclick = () => changeRankDialog(player.login, player.name);
Â  Â  Â  Â  }
Â  Â  Â  Â  else if ((myRole === 'admin' || myRole === 'trusted') && !player.login) {
Â  Â  Â  Â  Â  Â  inputName.style.cursor = "pointer";
Â  Â  Â  Â  Â  Â  inputName.style.borderBottom = "1px dashed var(--accent-brown)";
Â  Â  Â  Â  Â  Â  inputName.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const newName = prompt("ĞŸĞµÑ€ĞµĞ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ³Ğ¾ÑÑ‚Ñ:", player.name);
Â  Â  Â  Â  Â  Â  Â  Â  if (newName && newName.trim() !== "") update(ref(db, 'players/' + id), { name: newName.trim() });
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }

Â  Â  Â  Â  nameWrapper.appendChild(statusDot);Â 
Â  Â  Â  Â  nameWrapper.appendChild(roleBadge);
Â  Â  Â  Â  nameWrapper.appendChild(inputName);Â 

Â  Â  Â  Â  // Ğ—ĞĞœĞ•Ğ¢ĞšĞ˜
Â  Â  Â  Â  const uniqueKey = player.login || player.name;Â 
Â  Â  Â  Â  const localNotes = JSON.parse(localStorage.getItem('op_local_notes') || '{}');
Â  Â  Â  Â  const noteText = localNotes[uniqueKey];

Â  Â  Â  Â  if (myRole === 'admin') {
Â  Â  Â  Â  Â  Â  const btnNote = document.createElement('span');
Â  Â  Â  Â  Â  Â  btnNote.innerText = 'ğŸ“';
Â  Â  Â  Â  Â  Â  btnNote.className = 'btn-local-note';
Â  Â  Â  Â  Â  Â  if(noteText) btnNote.classList.add('has-note');
Â  Â  Â  Â  Â  Â  btnNote.onclick = () => setLocalNote(uniqueKey);
Â  Â  Â  Â  Â  Â  nameWrapper.appendChild(btnNote);
Â  Â  Â  Â  }

Â  Â  Â  Â  cellName.appendChild(nameWrapper);
Â  Â  Â  Â  if (noteText && myRole === 'admin') {
Â  Â  Â  Â  Â  Â  const noteDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  noteDiv.className = 'player-note-text';
Â  Â  Â  Â  Â  Â  noteDiv.innerText = noteText;
Â  Â  Â  Â  Â  Â  cellName.appendChild(noteDiv);
Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡
Â  Â  Â  Â  const cellStatus = newRow.insertCell(1);
Â  Â  Â  Â  cellStatus.className = 'status-cell';
Â  Â  Â  Â  let statusText = "Ğ”Ğ²Ğ¾Ñ€Ğ½Ğ¸Ğº";
Â  Â  Â  Â  let statusClass = "st-dvornik";
Â  Â  Â  Â  if (total >= 50000) { statusText = "Ğ§Ğ¸Ñ‚Ğ°Ğº ĞµĞ±Ğ°Ğ½Ñ‹Ğ¹"; statusClass = "st-cheat"; }
Â  Â  Â  Â  else if (total >= 10000) { statusText = "Ğ”Ğ¾Ğ½Ğ°Ñ‚ĞµÑ€"; statusClass = "st-donate"; }
Â  Â  Â  Â  else if (total >= 5000) { statusText = "Ğ‘Ğ¾Ğ³Ğ°Ñ‡"; statusClass = "st-rich"; }
Â  Â  Â  Â  else if (total >= 2000) { statusText = "Ğ¡Ñ€ĞµĞ´Ğ½ÑĞº"; statusClass = "st-mid"; }
Â  Â  Â  Â  else if (total >= 1000) { statusText = "ĞĞ¾Ğ²Ğ¾Ğ±Ñ€Ğ°Ğ½ĞµÑ†"; statusClass = "st-novo"; }
Â  Â  Â  Â  cellStatus.innerText = statusText;
Â  Â  Â  Â  cellStatus.classList.add(statusClass);

Â  Â  Â  Â  // 3. Ğ”Ğ•Ğ™Ğ¡Ğ¢Ğ’Ğ˜Ğ¯
Â  Â  Â  Â  const cellAction = newRow.insertCell(2);
Â  Â  Â  Â  if (myRole !== 'player') {
Â  Â  Â  Â  Â  Â  const inputNum = document.createElement('input');
Â  Â  Â  Â  Â  Â  inputNum.type = 'number';Â 
Â  Â  Â  Â  Â  Â  inputNum.className = 'input-val';Â 
Â  Â  Â  Â  Â  Â  inputNum.placeholder = '0';
Â  Â  Â  Â  Â  Â  inputNum.addEventListener('keypress', function(event) {
Â  Â  Â  Â  Â  Â  Â  Â  if (event.key === 'Enter') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  handleScore(id, inputNum, 1);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  cellAction.append(
Â  Â  Â  Â  Â  Â  Â  Â  inputNum,Â 
Â  Â  Â  Â  Â  Â  Â  Â  createBtn('+', 'btn-calc', () => handleScore(id, inputNum, 1)),
Â  Â  Â  Â  Â  Â  Â  Â  createBtn('-', 'btn-calc', () => handleScore(id, inputNum, -1)),
Â  Â  Â  Â  Â  Â  Â  Â  createBtn('â†©', 'btn-undo', () => undoLast(id)),
Â  Â  Â  Â  Â  Â  Â  Â  createBtn('â†ª', 'btn-redo', () => redoLast(id))
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  cellAction.innerText = "â€”";
Â  Â  Â  Â  }

Â  Â  Â  Â  // 4. Ğ˜Ğ¢ĞĞ“
Â  Â  Â  Â  const cellTotal = newRow.insertCell(3);
Â  Â  Â  Â  cellTotal.className = 'score-cell';
Â  Â  Â  Â  cellTotal.innerText = total;

Â  Â  Â  Â  // 5. Ğ˜Ğ¡Ğ¢ĞĞ Ğ˜Ğ¯
Â  Â  Â  Â  const cellHistory = newRow.insertCell(4);
Â  Â  Â  Â  cellHistory.className = 'history-log';
Â  Â  Â  Â  cellHistory.innerText = historyArray.length > 0 ? historyArray.map(n => n >= 0 ? `+${n}` : n).join(' ') : 'ĞŸÑƒÑÑ‚Ğ¾';

Â  Â  Â  Â  // 6. Ğ£Ğ”ĞĞ›Ğ•ĞĞ˜Ğ•
Â  Â  Â  Â  const cellDelete = newRow.insertCell(5);
Â  Â  Â  Â  const wrapper = document.createElement('div');
Â  Â  Â  Â  wrapper.style.display = 'flex'; wrapper.style.justifyContent = 'center'; wrapper.style.gap = '5px';
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (myRole === 'admin') {
Â  Â  Â  Â  Â  Â  Â wrapper.appendChild(createBtn('â™»ï¸', 'btn-reset-player', () => resetPlayer(id)));
Â  Â  Â  Â  Â  Â  Â if (player.login) {
Â  Â  Â  Â  Â  Â  Â  Â  Â wrapper.appendChild(createBtn('âœ•', 'btn-delete', () => safeDeletePlayer(id, player.login)));
Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â wrapper.appendChild(createBtn('âœ•', 'btn-delete', () => { if(confirm("Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ³Ğ¾ÑÑ‚Ñ Ğ½Ğ°Ğ²ÑĞµĞ³Ğ´Ğ°?")) remove(ref(db, 'players/' + id)); }));
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  }
Â  Â  Â  Â  cellDelete.appendChild(wrapper);
Â  Â  }

Â  Â  // --- Ğ›ĞĞšĞĞ›Ğ¬ĞĞ«Ğ• Ğ—ĞĞœĞ•Ğ¢ĞšĞ˜ ---
Â  Â  window.setLocalNote = function(key) {
Â  Â  Â  Â  // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ·Ğ°Ğ¼ĞµÑ‚ĞºĞ¸
Â  Â  Â  Â  const notes = JSON.parse(localStorage.getItem('op_local_notes') || '{}');
Â  Â  Â  Â  const current = notes[key] || "";
Â  Â  Â  Â Â 
Â  Â  Â  Â  const newNote = prompt("Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ° Ğ¾Ğ± Ğ¸Ğ³Ñ€Ğ¾ĞºĞµ (Ğ²Ğ¸Ğ´Ğ½Ğ° Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²Ğ°Ğ¼):", current);
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (newNote === null) return; // ĞÑ‚Ğ¼ĞµĞ½Ğ°
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (newNote.trim() === "") {
Â  Â  Â  Â  Â  Â  delete notes[key]; // Ğ•ÑĞ»Ğ¸ Ğ¿ÑƒÑÑ‚Ğ¾ â€” ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  notes[key] = newNote.trim(); // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  localStorage.setItem('op_local_notes', JSON.stringify(notes));
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ
Â  Â  Â  Â  const savedData = JSON.parse(localStorage.getItem('poker_data_v74'));
Â  Â  Â  Â  renderTable(savedData);
Â  Â  }

Â  Â  // --- Ğ¢ĞĞ‘Ğ›Ğ˜Ğ¦Ğ ---
Â  Â  window.refreshTable = async function() {
Â  Â  Â  Â  const pass = prompt("Ğ”Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ´ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°:");
Â  Â  Â  Â  if (pass !== "108020") { if(pass !== null) alert("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°"); return; }
Â  Â  Â  Â  try { await syncUsersToTable(); alert("Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ°!"); } catch(e) { alert("ĞÑˆĞ¸Ğ±ĞºĞ°: " + e.message); }
Â  Â  }

Â  Â  async function syncUsersToTable(currentDisplayName) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const usersSnap = await get(usersRef);
Â  Â  Â  Â  Â  Â  const playersSnap = await get(playersRef);
Â  Â  Â  Â  Â  Â  const users = usersSnap.val() || {};
Â  Â  Â  Â  Â  Â  const players = playersSnap.val() || {};
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const existingLogins = new Set();
Â  Â  Â  Â  Â  Â  for(let id in players) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  const pLogin = players[id].login || players[id].name;Â 
Â  Â  Â  Â  Â  Â  Â  Â  existingLogins.add(pLogin);Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const updates = {};
Â  Â  Â  Â  Â  Â  let hasUpdates = false;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  for(let login in users) {
Â  Â  Â  Â  Â  Â  Â  Â  if(!existingLogins.has(login)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const userData = users[login];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dispName = userData.displayName || login;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newKey = push(ref(db, 'players')).key;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ¿Ñ€Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğµ
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let historyToRestore = { 'start_bonus': 1000 };Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (userData.saved_history) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  historyToRestore = userData.saved_history;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updates['players/' + newKey] = {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: dispName,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  login: login,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  history: historyToRestoreÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hasUpdates = true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if(hasUpdates) { await update(ref(db), updates); }
Â  Â  Â  Â  } catch(e) { console.error("Sync error", e); }
Â  Â  }

Â  Â  window.editNickname = async function() {
Â  Â  Â  Â  let sessionUser = JSON.parse(sessionStorage.getItem('op_session_user'));
Â  Â  Â  Â  if (!sessionUser) sessionUser = JSON.parse(localStorage.getItem('op_user'));
Â  Â  Â  Â  if (!sessionUser) return;
Â  Â  Â  Â  const oldDisplayName = sessionUser.displayName || sessionUser.nick;
Â  Â  Â  Â  const newName = prompt("ĞĞ¾Ğ²Ğ¾Ğµ Ğ¸Ğ¼Ñ:", oldDisplayName);
Â  Â  Â  Â  if(!newName || newName.trim() === "") return;
Â  Â  Â  Â  const trimmedName = newName.trim();
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  await update(ref(db, 'users/' + sessionUser.nick), { displayName: trimmedName });
Â  Â  Â  Â  Â  Â  sessionUser.displayName = trimmedName;
Â  Â  Â  Â  Â  Â  sessionStorage.setItem('op_session_user', JSON.stringify(sessionUser));
Â  Â  Â  Â  Â  Â  if(localStorage.getItem('op_user')) {
Â  Â  Â  Â  Â  Â  Â  Â  let local = JSON.parse(localStorage.getItem('op_user'));
Â  Â  Â  Â  Â  Â  Â  Â  local.displayName = trimmedName;
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('op_user', JSON.stringify(local));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  updateMenuUI(trimmedName, sessionUser.nick);
Â  Â  Â  Â  Â  Â  const playersSnap = await get(playersRef);
Â  Â  Â  Â  Â  Â  playersSnap.forEach(child => {
Â  Â  Â  Â  Â  Â  Â  Â  const p = child.val();
Â  Â  Â  Â  Â  Â  Â  Â  if (p.login === sessionUser.nick || p.name === oldDisplayName) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  update(ref(db, 'players/' + child.key), { name: trimmedName, login: sessionUser.nick });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  } catch(e) { alert("Error: " + e.message); }
Â  Â  }

Â  Â  window.switchAuthView = function(view) {
Â  Â  Â  Â  document.getElementById('loginError').innerText = "";
Â  Â  Â  Â  document.getElementById('regError').innerText = "";
Â  Â  Â  Â  if(view === 'register') {
Â  Â  Â  Â  Â  Â  document.getElementById('login-view-card').classList.add('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById('register-view-card').classList.remove('hidden');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  document.getElementById('register-view-card').classList.add('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById('login-view-card').classList.remove('hidden');
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // Ğ‘Ğ•Ğ—ĞĞŸĞĞ¡ĞĞĞ• Ğ£Ğ”ĞĞ›Ğ•ĞĞ˜Ğ•
Â  Â  window.safeDeletePlayer = async function(id, login) {
Â  Â  Â  Â  if(!confirm("Ğ£Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ° ÑĞ¾ ÑÑ‚Ğ¾Ğ»Ğ°? (Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑÑ)")) return;
Â  Â  Â  Â  const snapshot = await get(ref(db, 'players/' + id));
Â  Â  Â  Â  const data = snapshot.val();
Â  Â  Â  Â  if (data && login) {
Â  Â  Â  Â  Â  Â  if (data.history) {
Â  Â  Â  Â  Â  Â  Â  Â  await update(ref(db, 'users/' + login), { saved_history: data.history });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  remove(ref(db, 'players/' + id));
Â  Â  }

Â  Â  // =========================================================
Â  Â  // ĞĞ’Ğ¢ĞĞ Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯
Â  Â  // =========================================================

Â  Â  // 1. Ğ Ğ•Ğ“Ğ˜Ğ¡Ğ¢Ğ ĞĞ¦Ğ˜Ğ¯
Â  Â  window.handleRegister = function() {
Â  Â  Â  Â  const nick = document.getElementById('regNick').value.trim();
Â  Â  Â  Â  const pass = document.getElementById('regPass').value.trim();
Â  Â  Â  Â  const passRepeat = document.getElementById('regPassRepeat').value.trim();

Â  Â  Â  Â  if(!nick || !pass) { document.getElementById('regError').innerText = "Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ²ÑĞµ Ğ¿Ğ¾Ğ»Ñ"; return; }
Â  Â  Â  Â  if(pass !== passRepeat) { document.getElementById('regError').innerText = "ĞŸĞ°Ñ€Ğ¾Ğ»Ğ¸ Ğ½Ğµ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°ÑÑ‚!"; return; }

Â  Â  Â  Â  get(child(ref(db), `users/${nick}`)).then((snapshot) => {
Â  Â  Â  Â  Â  Â  if (snapshot.exists()) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('regError').innerText = "ĞĞ¸Ğº Ğ·Ğ°Ğ½ÑÑ‚!";Â 
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  set(ref(db, 'users/' + nick), {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pass: pass,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created: Date.now(),Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayName: nick,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  role: 'player'Â 
Â  Â  Â  Â  Â  Â  Â  Â  }).then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newPlayerRef = push(ref(db, 'players'));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return set(newPlayerRef, { name: nick, login: nick, history: { 'start_bonus': 1000 } });
Â  Â  Â  Â  Â  Â  Â  Â  }).then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert("ĞĞºĞºĞ°ÑƒĞ½Ñ‚ ÑĞ¾Ğ·Ğ´Ğ°Ğ½! Ğ’Ñ…Ğ¾Ğ´Ğ¸Ñ‚Ğµ.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  switchAuthView('login');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('loginNick').value = nick;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('loginPass').value = pass;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // 2. Ğ’Ğ¥ĞĞ”
Â  Â  window.handleLogin = function() {
Â  Â  Â  Â  const nick = document.getElementById('loginNick').value.trim();
Â  Â  Â  Â  const pass = document.getElementById('loginPass').value.trim();
Â  Â  Â  Â  const remember = document.getElementById('rememberMe').checked;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(!nick || !pass) {Â 
Â  Â  Â  Â  Â  Â  document.getElementById('loginError').innerText = "Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ";Â 
Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  checkLogin(nick, pass, false, remember);
Â  Â  }

Â  Â  async function checkLogin(nick, pass, isAuto, remember = false) {
Â  Â  Â  Â  // ĞÑ„Ğ»Ğ°Ğ¹Ğ½-Ğ²Ñ…Ğ¾Ğ´ Ñ‡ĞµÑ€ĞµĞ· ĞºÑÑˆ
Â  Â  Â  Â  const tryLocalLogin = () => {
Â  Â  Â  Â  Â  Â  const knownUsers = JSON.parse(localStorage.getItem('op_known_users') || '{}');
Â  Â  Â  Â  Â  Â  if (knownUsers[nick] && knownUsers[nick] === pass) {
Â  Â  Â  Â  Â  Â  Â  Â  const cachedUser = JSON.parse(localStorage.getItem('op_user') || '{}');
Â  Â  Â  Â  Â  Â  Â  Â  // Ğ•ÑĞ»Ğ¸ ĞºÑÑˆ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ Ñ Ğ²Ğ²ĞµĞ´ĞµĞ½Ğ½Ñ‹Ğ¼ Ğ½Ğ¸ĞºĞ¾Ğ¼
Â  Â  Â  Â  Â  Â  Â  Â  if (cachedUser.nick === nick) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const savedRole = cachedUser.role || 'player';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ğ’Ğ°Ğ¶Ğ½Ğ¾: Ğ±ĞµÑ€ĞµĞ¼ Ğ¸Ğ¼Ñ Ğ¸Ğ· ĞºÑÑˆĞ° Ğ˜Ğ›Ğ˜ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ½Ğ¸Ğº
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const name = cachedUser.displayName || nick;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  performLogin(nick, pass, remember || isAuto, name, savedRole);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  };

Â  Â  Â  Â  if (!navigator.onLine) {
Â  Â  Â  Â  Â  Â  if (!tryLocalLogin() && !isAuto) document.getElementById('loginError').innerText = "ĞĞµÑ‚ ÑĞµÑ‚Ğ¸";
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const snapshot = await get(child(ref(db), `users/${nick}`));
Â  Â  Â  Â  Â  Â  if (snapshot.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  const userData = snapshot.val();
Â  Â  Â  Â  Â  Â  Â  Â  if(userData.pass === pass) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ² Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğµ
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let knownUsers = JSON.parse(localStorage.getItem('op_known_users') || '{}');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  knownUsers[nick] = pass;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('op_known_users', JSON.stringify(knownUsers));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dispName = userData.displayName || nick;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dbRole = userData.role || 'player';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ ĞºÑÑˆ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const userObj = { nick, pass, displayName: dispName, role: dbRole };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('op_user', JSON.stringify(userObj));

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  performLogin(nick, pass, remember || isAuto, dispName, dbRole);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!isAuto) document.getElementById('loginError').innerText = "ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(isAuto) { localStorage.removeItem('op_user'); sessionStorage.removeItem('op_session_user'); }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  if(!isAuto) document.getElementById('loginError').innerText = "ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  if (!tryLocalLogin() && !isAuto) document.getElementById('loginError').innerText = "ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ‚Ğ¸";
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function performLogin(nick, pass, remember, displayName, loadedRole) {
Â  Â  Â  Â  document.getElementById('login-overlay').style.display = 'none';
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ¸Ğ¼Ñ Ğ½Ğµ Ğ¿ÑƒÑÑ‚Ğ¾Ğµ
Â  Â  Â  Â  const finalName = displayName || nick;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ UI Ğ¡Ğ ĞĞ—Ğ£
Â  Â  Â  Â  updateMenuUI(finalName, nick);
Â  Â  Â  Â Â 
Â  Â  Â  Â  let role = loadedRole || 'player';
Â  Â  Â  Â  if (nick === 'Zagonskiy') {
Â  Â  Â  Â  Â  Â  role = 'admin';
Â  Â  Â  Â  }Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  const userObj = { nick, pass, displayName: finalName, role: role };
Â  Â  Â  Â Â 
Â  Â  Â  Â  sessionStorage.setItem('op_session_user', JSON.stringify(userObj));
Â  Â  Â  Â  if(remember) localStorage.setItem('op_user', JSON.stringify(userObj));
Â  Â  Â  Â Â 
Â  Â  Â  Â  setOnlineStatus(nick);
Â  Â  Â  Â  fetchUserRole(nick);Â 
Â  Â  Â  Â  applyRoleUI();
Â  Â  }

Â  Â  function fetchUserRole(nick) {
Â  Â  Â  Â  if (nick === 'Zagonskiy') return;Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  get(child(ref(db), `users/${nick}/role`)).then((snap) => {
Â  Â  Â  Â  Â  Â  let role = snap.val() || 'player';
Â  Â  Â  Â  Â  Â  let sessionUser = JSON.parse(sessionStorage.getItem('op_session_user'));
Â  Â  Â  Â  Â  Â  if(sessionUser) {
Â  Â  Â  Â  Â  Â  Â  Â  if (sessionUser.role !== role) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sessionUser.role = role;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sessionStorage.setItem('op_session_user', JSON.stringify(sessionUser));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  applyRoleUI();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // --- Ğ˜ĞĞ¢Ğ•Ğ Ğ¤Ğ•Ğ™Ğ¡ Ğ˜ ĞšĞĞĞŸĞšĞ˜ ---
Â  Â  window.applyRoleUI = function() {
Â  Â  Â  Â  const sessionUser = JSON.parse(sessionStorage.getItem('op_session_user'));
Â  Â  Â  Â  const role = sessionUser ? sessionUser.role : 'player';

Â  Â  Â  Â  const controlsDiv = document.querySelector('.controls');
Â  Â  Â  Â  // Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€ÑƒÑ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
Â  Â  Â  Â  const oldRestore = document.getElementById('btnRestore');
Â  Â  Â  Â  if(oldRestore) oldRestore.remove();

Â  Â  Â  Â  const extremeResetBtn = document.querySelector('.btn-extreme-reset');
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (role === 'player') {
Â  Â  Â  Â  Â  Â  if(controlsDiv) controlsDiv.classList.add('role-hidden');
Â  Â  Â  Â  Â  Â  if(extremeResetBtn) extremeResetBtn.classList.add('role-hidden');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // Ğ•ÑĞ»Ğ¸ ĞĞ´Ğ¼Ğ¸Ğ½ Ğ¸Ğ»Ğ¸ Ğ”Ğ¾Ğ²ĞµÑ€ĞµĞ½Ğ½Ñ‹Ğ¹ - Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ
Â  Â  Â  Â  Â  Â  if(controlsDiv) {
Â  Â  Â  Â  Â  Â  Â  Â  controlsDiv.classList.remove('role-hidden');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ
Â  Â  Â  Â  Â  Â  Â  Â  if (!document.getElementById('btnRestore')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const btnRestore = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btnRestore.id = 'btnRestore';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btnRestore.className = 'btn-refresh';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btnRestore.innerText = 'â™»ï¸ Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btnRestore.onclick = window.restorePlayers;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const btnAdd = document.querySelector('.btn-add');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(btnAdd && btnAdd.parentNode) btnAdd.parentNode.insertBefore(btnRestore, btnAdd.nextSibling);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (role === 'admin') {
Â  Â  Â  Â  Â  Â  Â  Â  if(extremeResetBtn) extremeResetBtn.classList.remove('role-hidden');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  if(extremeResetBtn) extremeResetBtn.classList.add('role-hidden');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  const savedData = JSON.parse(localStorage.getItem('poker_data_v74'));
Â  Â  Â  Â  if (savedData) renderTable(savedData);
Â  Â  }

Â  Â  // Ğ£Ğ¼Ğ½Ğ¾Ğµ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ
Â  Â  window.restorePlayers = async function() {
Â  Â  Â  Â  if(!confirm("Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒ Ğ²ÑĞµÑ… Ğ·Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ² Ğ·Ğ° ÑÑ‚Ğ¾Ğ»?")) return;
Â  Â  Â  Â  await syncUsersToTable();
Â  Â  Â  Â  alert("Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½!");
Â  Â  }

Â  Â  window.logout = function() {
Â  Â  Â  Â  if(confirm("Ğ’Ñ‹Ğ¹Ñ‚Ğ¸?")) {
Â  Â  Â  Â  Â  Â  if (currentConnectionRef) remove(currentConnectionRef);
Â  Â  Â  Â  Â  Â  localStorage.removeItem('op_user');
Â  Â  Â  Â  Â  Â  sessionStorage.removeItem('op_session_user');
Â  Â  Â  Â  Â  Â  location.reload();
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function setOnlineStatus(nickname) {
Â  Â  Â  Â  const myUserRef = ref(db, `online_users/${nickname}`);
Â  Â  Â  Â  currentConnectionRef = push(myUserRef);
Â  Â  Â  Â  onDisconnect(currentConnectionRef).remove();
Â  Â  Â  Â  set(currentConnectionRef, true);
Â  Â  }

Â  Â  onValue(connectedRef, (snap) => {
Â  Â  Â  Â  const dotMobile = document.getElementById('mobileStatusDot');
Â  Â  Â  Â  const dotDesktop = document.getElementById('desktopStatusDot');
Â  Â  Â  Â  const statusEl = document.getElementById('networkStatus');
Â  Â  Â  Â  if(statusEl) statusEl.style.display = 'none';
Â  Â  Â  Â  if (snap.val() === true) {
Â  Â  Â  Â  Â  Â  dotMobile.classList.add('online'); dotDesktop.classList.add('online');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  dotMobile.classList.remove('online'); dotDesktop.classList.remove('online');
Â  Â  Â  Â  }
Â  Â  });

Â  Â  onValue(onlineUsersRef, (snap) => {
Â  Â  Â  Â  const countDisplay = document.getElementById('onlineCounter');
Â  Â  Â  Â  onlineNicknames.clear();
Â  Â  Â  Â  if (snap.exists()) {
Â  Â  Â  Â  Â  Â  const data = snap.val();
Â  Â  Â  Â  Â  Â  Object.keys(data).forEach(n => onlineNicknames.add(n));
Â  Â  Â  Â  Â  Â  countDisplay.innerText = `ğŸ‘ï¸ ĞĞ½Ğ»Ğ°Ğ¹Ğ½: ${onlineNicknames.size}`;
Â  Â  Â  Â  } else { countDisplay.innerText = `ğŸ‘ï¸ ĞĞ½Ğ»Ğ°Ğ¹Ğ½: 0`; }
Â  Â  Â  Â  updateTableStatusDots();
Â  Â  });

Â  Â  function updateTableStatusDots() {
Â  Â  Â  Â  document.querySelectorAll('.player-status-indicator').forEach(dot => {
Â  Â  Â  Â  Â  Â  const name = dot.getAttribute('data-player-name');
Â  Â  Â  Â  Â  Â  const login = dot.getAttribute('data-player-login');
Â  Â  Â  Â  Â  Â  const keyToCheck = login || name;
Â  Â  Â  Â  Â  Â  if (onlineNicknames.has(keyToCheck)) dot.classList.add('is-online');
Â  Â  Â  Â  Â  Â  else dot.classList.remove('is-online');
Â  Â  Â  Â  });
Â  Â  }

Â  Â  onValue(playersRef, (snapshot) => {
Â  Â  Â  Â  const data = snapshot.val();
Â  Â  Â  Â  if (!data) return;
Â  Â  Â  Â  localStorage.setItem('poker_data_v74', JSON.stringify(data));
Â  Â  Â  Â  renderTable(data);
Â  Â  });

Â  Â  function renderTable(data) {
Â  Â  Â  Â  if (document.activeElement.tagName === 'INPUT') return;Â 
Â  Â  Â  Â  const tableBody = document.getElementById('tableBody');
Â  Â  Â  Â  tableBody.innerHTML = '';
Â  Â  Â  Â  for (let id in data) { renderPlayerRow(id, data[id]); }
Â  Â  Â  Â  recalculateGrandTotal();
Â  Â  Â  Â  updateTableStatusDots();
Â  Â  }

Â  Â  function recalculateGrandTotal() {
Â  Â  Â  Â  const scoreCells = document.querySelectorAll('.score-cell');
Â  Â  Â  Â  let totalSum = 0;
Â  Â  Â  Â  scoreCells.forEach(cell => totalSum += parseFloat(cell.innerText || 0));
Â  Â  Â  Â  document.getElementById('grandTotal').innerText = totalSum;
Â  Â  }

Â  Â  function calculatePlayerStats(player) {
Â  Â  Â  Â  let historyArray = [];
Â  Â  Â  Â  let total = 0;
Â  Â  Â  Â  if (player.history) {
Â  Â  Â  Â  Â  Â  if (typeof player.history === 'object' && !Array.isArray(player.history)) {
Â  Â  Â  Â  Â  Â  Â  Â  historyArray = Object.values(player.history);
Â  Â  Â  Â  Â  Â  } else if (Array.isArray(player.history)) {
Â  Â  Â  Â  Â  Â  Â  Â  historyArray = player.history;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  historyArray.forEach(val => total += val);
Â  Â  Â  Â  return { total, historyArray };
Â  Â  }

Â  Â  function renderPlayerRow(id, player) {
Â  Â  Â  Â  const sessionUser = JSON.parse(sessionStorage.getItem('op_session_user')) || { role: 'player' };
Â  Â  Â  Â  const myRole = sessionUser.role;

Â  Â  Â  Â  const tableBody = document.getElementById('tableBody');
Â  Â  Â  Â  const newRow = tableBody.insertRow();
Â  Â  Â  Â  const { total, historyArray } = calculatePlayerStats(player);

Â  Â  Â  Â  // 1. Ğ˜ĞœĞ¯
Â  Â  Â  Â  const cellName = newRow.insertCell(0);
Â  Â  Â  Â  const nameWrapper = document.createElement('div');
Â  Â  Â  Â  nameWrapper.className = 'name-wrapper';
Â  Â  Â  Â Â 
Â  Â  Â  Â  const statusDot = document.createElement('div');
Â  Â  Â  Â  statusDot.className = 'player-status-indicator';
Â  Â  Â  Â  statusDot.setAttribute('data-player-name', player.name);
Â  Â  Â  Â  if(player.login) statusDot.setAttribute('data-player-login', player.login);
Â  Â  Â  Â  const keyToCheck = player.login || player.name;
Â  Â  Â  Â  if (onlineNicknames.has(keyToCheck)) statusDot.classList.add('is-online');

Â  Â  Â  Â  const roleBadge = document.createElement('span');
Â  Â  Â  Â  roleBadge.className = 'role-badge';
Â  Â  Â  Â  if (!player.login) { roleBadge.innerText = 'ğŸ‘½'; roleBadge.title = 'Ğ“Ğ¾ÑÑ‚ÑŒ'; }Â 
Â  Â  Â  Â  else if (player.login === 'Zagonskiy') { roleBadge.innerText = 'ğŸ‘‘'; roleBadge.title = 'Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ĞµĞ»ÑŒ'; }
Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  roleBadge.innerText = 'â³';
Â  Â  Â  Â  Â  Â  get(child(ref(db), 'users/' + player.login + '/role')).then((snap) => {
Â  Â  Â  Â  Â  Â  Â  Â  const r = snap.val();
Â  Â  Â  Â  Â  Â  Â  Â  if (r === 'admin') { roleBadge.innerText = 'ğŸ‘‘'; roleBadge.title = 'ĞĞ´Ğ¼Ğ¸Ğ½'; }
Â  Â  Â  Â  Â  Â  Â  Â  else if (r === 'trusted') { roleBadge.innerText = 'ğŸ›¡ï¸'; roleBadge.title = 'Ğ”Ğ¾Ğ²ĞµÑ€ĞµĞ½Ğ½Ñ‹Ğ¹'; }
Â  Â  Â  Â  Â  Â  Â  Â  else { roleBadge.innerText = 'ğŸ‘¤'; roleBadge.title = 'Ğ˜Ğ³Ñ€Ğ¾Ğº'; }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  const inputName = document.createElement('input');
Â  Â  Â  Â  inputName.type = 'text';Â 
Â  Â  Â  Â  inputName.className = 'player-name';Â 
Â  Â  Â  Â  inputName.value = player.name || "";
Â  Â  Â  Â  inputName.readOnly = true;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (myRole === 'admin' && player.login) {
Â  Â  Â  Â  Â  Â  inputName.style.cursor = "pointer";
Â  Â  Â  Â  Â  Â  inputName.style.textDecoration = "underline";
Â  Â  Â  Â  Â  Â  inputName.onclick = () => changeRankDialog(player.login, player.name);
Â  Â  Â  Â  }
Â  Â  Â  Â  else if ((myRole === 'admin' || myRole === 'trusted') && !player.login) {
Â  Â  Â  Â  Â  Â  inputName.style.cursor = "pointer";
Â  Â  Â  Â  Â  Â  inputName.style.borderBottom = "1px dashed var(--accent-brown)";
Â  Â  Â  Â  Â  Â  inputName.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const newName = prompt("ĞŸĞµÑ€ĞµĞ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ³Ğ¾ÑÑ‚Ñ:", player.name);
Â  Â  Â  Â  Â  Â  Â  Â  if (newName && newName.trim() !== "") update(ref(db, 'players/' + id), { name: newName.trim() });
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }

Â  Â  Â  Â  nameWrapper.appendChild(statusDot);Â 
Â  Â  Â  Â  nameWrapper.appendChild(roleBadge);
Â  Â  Â  Â  nameWrapper.appendChild(inputName);Â 

Â  Â  Â  Â  // Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ¸
Â  Â  Â  Â  const uniqueKey = player.login || player.name;Â 
Â  Â  Â  Â  const localNotes = JSON.parse(localStorage.getItem('op_local_notes') || '{}');
Â  Â  Â  Â  const noteText = localNotes[uniqueKey];

Â  Â  Â  Â  if (myRole === 'admin') {
Â  Â  Â  Â  Â  Â  const btnNote = document.createElement('span');
Â  Â  Â  Â  Â  Â  btnNote.innerText = 'ğŸ“';
Â  Â  Â  Â  Â  Â  btnNote.className = 'btn-local-note';
Â  Â  Â  Â  Â  Â  if(noteText) btnNote.classList.add('has-note');
Â  Â  Â  Â  Â  Â  btnNote.onclick = () => setLocalNote(uniqueKey);
Â  Â  Â  Â  Â  Â  nameWrapper.appendChild(btnNote);
Â  Â  Â  Â  }

Â  Â  Â  Â  cellName.appendChild(nameWrapper);
Â  Â  Â  Â  if (noteText && myRole === 'admin') {
Â  Â  Â  Â  Â  Â  const noteDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  noteDiv.className = 'player-note-text';
Â  Â  Â  Â  Â  Â  noteDiv.innerText = noteText;
Â  Â  Â  Â  Â  Â  cellName.appendChild(noteDiv);
Â  Â  Â  Â  }

Â  Â  Â  Â  // 2. Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡ (ĞĞĞ’ĞĞ¯ ĞšĞĞ›ĞĞĞšĞ)
Â  Â  Â  Â  const cellStatus = newRow.insertCell(1);
Â  Â  Â  Â  cellStatus.className = 'status-cell';
Â  Â  Â  Â Â 
Â  Â  Â  Â  let statusText = "Ğ”Ğ²Ğ¾Ñ€Ğ½Ğ¸Ğº";
Â  Â  Â  Â  let statusClass = "st-dvornik";

Â  Â  Â  Â  if (total >= 50000) { statusText = "Ğ§Ğ¸Ñ‚Ğ°Ğº ĞµĞ±Ğ°Ğ½Ñ‹Ğ¹"; statusClass = "st-cheat"; }
Â  Â  Â  Â  else if (total >= 10000) { statusText = "Ğ”Ğ¾Ğ½Ğ°Ñ‚ĞµÑ€"; statusClass = "st-donate"; }
Â  Â  Â  Â  else if (total >= 5000) { statusText = "Ğ‘Ğ¾Ğ³Ğ°Ñ‡"; statusClass = "st-rich"; }
Â  Â  Â  Â  else if (total >= 2000) { statusText = "Ğ¡Ñ€ĞµĞ´Ğ½ÑĞº"; statusClass = "st-mid"; }
Â  Â  Â  Â  else if (total >= 1000) { statusText = "ĞĞ¾Ğ²Ğ¾Ğ±Ñ€Ğ°Ğ½ĞµÑ†"; statusClass = "st-novo"; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  cellStatus.innerText = statusText;
Â  Â  Â  Â  cellStatus.classList.add(statusClass);


Â  Â  Â  Â  // 3. Ğ”Ğ•Ğ™Ğ¡Ğ¢Ğ’Ğ˜Ğ¯
Â  Â  Â  Â  const cellAction = newRow.insertCell(2);
Â  Â  Â  Â  if (myRole !== 'player') {
Â  Â  Â  Â  Â  Â  const inputNum = document.createElement('input');
Â  Â  Â  Â  Â  Â  inputNum.type = 'number';Â 
Â  Â  Â  Â  Â  Â  inputNum.className = 'input-val';Â 
Â  Â  Â  Â  Â  Â  inputNum.placeholder = '0';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  inputNum.addEventListener('keypress', function(event) {
Â  Â  Â  Â  Â  Â  Â  Â  if (event.key === 'Enter') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  handleScore(id, inputNum, 1);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  cellAction.append(
Â  Â  Â  Â  Â  Â  Â  Â  inputNum,Â 
Â  Â  Â  Â  Â  Â  Â  Â  createBtn('+', 'btn-calc', () => handleScore(id, inputNum, 1)),
Â  Â  Â  Â  Â  Â  Â  Â  createBtn('-', 'btn-calc', () => handleScore(id, inputNum, -1)),
Â  Â  Â  Â  Â  Â  Â  Â  createBtn('â†©', 'btn-undo', () => undoLast(id)),
Â  Â  Â  Â  Â  Â  Â  Â  createBtn('â†ª', 'btn-redo', () => redoLast(id))
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  cellAction.innerText = "â€”";
Â  Â  Â  Â  }

Â  Â  Â  Â  // 4. Ğ˜Ğ¢ĞĞ“
Â  Â  Â  Â  const cellTotal = newRow.insertCell(3);
Â  Â  Â  Â  cellTotal.className = 'score-cell';
Â  Â  Â  Â  cellTotal.innerText = total;

Â  Â  Â  Â  // 5. Ğ˜Ğ¡Ğ¢ĞĞ Ğ˜Ğ¯
Â  Â  Â  Â  const cellHistory = newRow.insertCell(4);
Â  Â  Â  Â  cellHistory.className = 'history-log';
Â  Â  Â  Â  cellHistory.innerText = historyArray.length > 0 ? historyArray.map(n => n >= 0 ? `+${n}` : n).join(' ') : 'ĞŸÑƒÑÑ‚Ğ¾';

Â  Â  Â  Â  // 6. Ğ£Ğ”ĞĞ›Ğ•ĞĞ˜Ğ•
Â  Â  Â  Â  const cellDelete = newRow.insertCell(5);
Â  Â  Â  Â  const wrapper = document.createElement('div');
Â  Â  Â  Â  wrapper.style.display = 'flex'; wrapper.style.justifyContent = 'center'; wrapper.style.gap = '5px';
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (myRole === 'admin') {
Â  Â  Â  Â  Â  Â  Â wrapper.appendChild(createBtn('â™»ï¸', 'btn-reset-player', () => resetPlayer(id)));
Â  Â  Â  Â  Â  Â  Â if (player.login) {
Â  Â  Â  Â  Â  Â  Â  Â  Â wrapper.appendChild(createBtn('âœ•', 'btn-delete', () => safeDeletePlayer(id, player.login)));
Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â wrapper.appendChild(createBtn('âœ•', 'btn-delete', () => { if(confirm("Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ³Ğ¾ÑÑ‚Ñ Ğ½Ğ°Ğ²ÑĞµĞ³Ğ´Ğ°?")) remove(ref(db, 'players/' + id)); }));
Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  }
Â  Â  Â  Â  cellDelete.appendChild(wrapper);
Â  Â  }
Â  Â  function createBtn(text, cls, onClick) {
Â  Â  Â  Â  const btn = document.createElement('button');
Â  Â  Â  Â  btn.innerText = text; btn.className = cls; btn.onclick = onClick;
Â  Â  Â  Â  return btn;
Â  Â  }

Â  Â  window.handleScore = function(id, inputElem, multiplier) {
Â  Â  Â  Â  let val = parseFloat(inputElem.value);
Â  Â  Â  Â  if (isNaN(val)) return;
Â  Â  Â  Â  let change = val * multiplier;
Â  Â  Â  Â  push(ref(db, 'players/' + id + '/history'), change);
Â  Â  Â  Â  set(ref(db, 'players/' + id + '/redoStack'), null);
Â  Â  Â  Â  const row = inputElem.closest('tr');
Â  Â  Â  Â  const totalCell = row.querySelector('.score-cell');
Â  Â  Â  Â  const historyCell = row.querySelector('.history-log');
Â  Â  Â  Â  let currentTotal = parseFloat(totalCell.innerText || 0);
Â  Â  Â  Â  totalCell.innerText = currentTotal + change;
Â  Â  Â  Â  let text = historyCell.innerText;
Â  Â  Â  Â  let newEntry = (change >= 0 ? `+${change}` : change);
Â  Â  Â  Â  if (text === 'ĞŸÑƒÑÑ‚Ğ¾') historyCell.innerText = newEntry;
Â  Â  Â  Â  else historyCell.innerText = text + ' ' + newEntry;
Â  Â  Â  Â  inputElem.value = ''; inputElem.focus();
Â  Â  Â  Â  recalculateGrandTotal();
Â  Â  }

Â  Â  window.undoLast = async function(id) {
Â  Â  Â  Â  const historyRef = ref(db, 'players/' + id + '/history');
Â  Â  Â  Â  const lastItemQuery = query(historyRef, orderByKey(), limitToLast(1));
Â  Â  Â  Â  const snapshot = await get(lastItemQuery);
Â  Â  Â  Â  snapshot.forEach((child) => {
Â  Â  Â  Â  Â  Â  const val = child.val();
Â  Â  Â  Â  Â  Â  remove(child.ref);
Â  Â  Â  Â  Â  Â  push(ref(db, 'players/' + id + '/redoStack'), val);
Â  Â  Â  Â  });
Â  Â  }

Â  Â  window.redoLast = async function(id) {
Â  Â  Â  Â  const redoRef = ref(db, 'players/' + id + '/redoStack');
Â  Â  Â  Â  const lastRedoQuery = query(redoRef, orderByKey(), limitToLast(1));
Â  Â  Â  Â  const snapshot = await get(lastRedoQuery);
Â  Â  Â  Â  snapshot.forEach((child) => {
Â  Â  Â  Â  Â  Â  const val = child.val();
Â  Â  Â  Â  Â  Â  remove(child.ref);
Â  Â  Â  Â  Â  Â  push(ref(db, 'players/' + id + '/history'), val);
Â  Â  Â  Â  });
Â  Â  }

Â  Â  window.createNewPlayer = function() {
Â  Â  Â  Â  let guestName = prompt("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¸Ğ¼Ñ Ğ³Ğ¾ÑÑ‚Ñ:", "Ğ“Ğ¾ÑÑ‚ÑŒ");
Â  Â  Â  Â  // Ğ•ÑĞ»Ğ¸ Ğ½Ğ°Ğ¶Ğ°Ğ»Ğ¸ "ĞÑ‚Ğ¼ĞµĞ½Ğ°", Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ ÑĞ¾Ğ·Ğ´Ğ°ĞµĞ¼
Â  Â  Â  Â  if (guestName === null) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Ğ•ÑĞ»Ğ¸ Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ğ»Ğ¸ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼, Ğ½Ğ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ "Ğ“Ğ¾ÑÑ‚ÑŒ"
Â  Â  Â  Â  if (guestName.trim() === "") guestName = "Ğ“Ğ¾ÑÑ‚ÑŒ";
Â  Â  Â  Â Â 
Â  Â  Â  Â  push(playersRef, {Â 
Â  Â  Â  Â  Â  Â  name: guestName.trim(),Â 
Â  Â  Â  Â  Â  Â  history: {}Â 
Â  Â  Â  Â  });
Â  Â  }
Â  Â  window.resetPlayer = (id) => { if (prompt("Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ° (ĞšĞ¾Ğ´)?") === "108020") update(ref(db, 'players/' + id), { history: null, redoStack: null }); else alert("ĞÑˆĞ¸Ğ±ĞºĞ°"); };
Â  Â  window.extremeReset = async () => { if (prompt("ĞŸĞĞ›ĞĞ«Ğ™ Ğ¡Ğ‘Ğ ĞĞ¡ (ĞšĞ¾Ğ´)?") === "108020") { const snap = await get(playersRef); const updates = {}; snap.forEach(child => { updates['players/' + child.key + '/history'] = null; updates['players/' + child.key + '/redoStack'] = null; }); await update(ref(db), updates); } };
Â  Â  window.startNewDay = async () => { if (prompt("ĞĞĞ’Ğ«Ğ™ Ğ”Ğ•ĞĞ¬ (ĞšĞ¾Ğ´)?") === "108020") { const snap = await get(playersRef); const updates = {}; snap.forEach(child => { const { total } = calculatePlayerStats(child.val()); const key1 = push(ref(db)).key; const key2 = push(ref(db)).key; const newHistory = {}; newHistory[key1] = total; newHistory[key2] = 500; updates['players/' + child.key + '/history'] = newHistory; updates['players/' + child.key + '/redoStack'] = null; }); await update(ref(db), updates); alert("Ğ”ĞµĞ½ÑŒ Ğ½Ğ°Ñ‡Ğ°Ñ‚! +500"); } };
Â  Â Â 
Â  Â  // Ğ–Ğ£Ğ ĞĞĞ›
Â  Â  window.addToJournal=async function(){if(!confirm("Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ¸Ñ‚Ğ¾Ğ³Ğ¸ Ğ² Ğ–ÑƒÑ€Ğ½Ğ°Ğ»?"))return;const dv=document.getElementById('gameDate').value;if(!dv){alert("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ°Ñ‚Ñ‹!");return;}const[y,m,d]=dv.split('-');const fd=`${d}.${m}.${y}`;const s=await get(playersRef);const dt=s.val();if(!dt)return;let gt=0;const sp=[];for(let i in dt){const p=dt[i];const{total,historyArray}=calculatePlayerStats(p);gt+=total;sp.push({name:p.name||"Ğ‘ĞµĞ· Ğ¸Ğ¼ĞµĞ½Ğ¸",total:total,history:historyArray.join(' ')})}push(journalRef,{date:fd+' '+new Date().toLocaleTimeString().slice(0,5),timestamp:Date.now(),grandTotal:gt,players:sp});alert("Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾ Ğ·Ğ° "+fd+"!");};

Â  Â  window.deleteJournalEntry = function(id) {Â 
Â  Â  Â  Â  const sessionUser = JSON.parse(sessionStorage.getItem('op_session_user'));
Â  Â  Â  Â  if (sessionUser.role === 'admin' || sessionUser.role === 'trusted') {
Â  Â  Â  Â  Â  Â  Â if(confirm("Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ?")) remove(ref(db, 'journal/' + id));
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â alert("ĞĞµÑ‚ Ğ¿Ñ€Ğ°Ğ²!");
Â  Â  Â  Â  }
Â  Â  }

Â  Â  onValue(journalRef, (snapshot) => {
Â  Â  Â  Â  const listDiv = document.getElementById('journalList');
Â  Â  Â  Â  listDiv.innerHTML = '';
Â  Â  Â  Â  const data = snapshot.val();
Â  Â  Â  Â Â 
Â  Â  Â  Â  const sessionUser = JSON.parse(sessionStorage.getItem('op_session_user')) || { role: 'player' };
Â  Â  Â  Â  const canDelete = (sessionUser.role === 'admin' || sessionUser.role === 'trusted');

Â  Â  Â  Â  if (!data) {
Â  Â  Â  Â  Â  Â  listDiv.innerHTML = '<div style="text-align:center;">ĞŸÑƒÑÑ‚Ğ¾</div>';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const entries = Object.entries(data).sort((a, b) => b[1].timestamp - a[1].timestamp);

Â  Â  Â  Â  entries.forEach(([id, entry]) => {
Â  Â  Â  Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  Â  Â  Â  card.className = 'journal-card';
Â  Â  Â  Â  Â  Â  const header = document.createElement('div');
Â  Â  Â  Â  Â  Â  header.className = 'journal-header';

Â  Â  Â  Â  Â  Â  let deleteBtnHtml = '';
Â  Â  Â  Â  Â  Â  if (canDelete) {
Â  Â  Â  Â  Â  Â  Â  Â  deleteBtnHtml = `<button class="btn-journal-delete" onclick="event.stopPropagation(); deleteJournalEntry('${id}')">ğŸ—‘ï¸</button>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  header.innerHTML = `<div style="display:flex; align-items:center;"><span>ğŸ“… ${entry.date}</span>${deleteBtnHtml}</div><span class="journal-total">Ğ‘Ğ°Ğ½Ğº: ${entry.grandTotal}</span>`;
Â  Â  Â  Â  Â  Â  const details = document.createElement('div');
Â  Â  Â  Â  Â  Â  details.className = 'journal-details';
Â  Â  Â  Â  Â  Â  let detailsHtml = `<div style="font-weight:bold; border-bottom:1px solid #000; margin-bottom:5px; display:flex; justify-content:space-between;"><span>Ğ˜Ğ³Ñ€Ğ¾Ğº</span><span>Ğ˜Ñ‚Ğ¾Ğ³</span></div>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (entry.players) {
Â  Â  Â  Â  Â  Â  Â  Â  entry.players.forEach(p => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  detailsHtml += `<div class="detail-row"><span style="font-weight:bold;">${p.name}</span><span style="color:${p.total >= 0 ? 'green' : 'red'}">${p.total}</span></div><div style="font-size:0.8em; color:#666; margin-bottom:5px;">${p.history}</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  details.innerHTML = detailsHtml;
Â  Â  Â  Â  Â  Â  card.appendChild(header);
Â  Â  Â  Â  Â  Â  card.appendChild(details);
Â  Â  Â  Â  Â  Â  card.onclick = () => card.classList.toggle('open');
Â  Â  Â  Â  Â  Â  listDiv.appendChild(card);
Â  Â  Â  Â  });
Â  Â  });

Â  Â  // --- Ğ£ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ ĞĞ›Ğ¯ĞœĞ˜ ---
Â  Â  let currentRankLogin = null;

Â  Â  window.changeRankDialog = function(login, currentName) {
Â  Â  Â  Â  const sessionUser = JSON.parse(sessionStorage.getItem('op_session_user'));
Â  Â  Â  Â  if (!sessionUser || sessionUser.role !== 'admin') return;
Â  Â  Â  Â  if (login === 'Zagonskiy') { alert("ĞĞµĞ»ÑŒĞ·Ñ Ğ¼ĞµĞ½ÑÑ‚ÑŒ Ñ€Ğ°Ğ½Ğ³ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ĞµĞ»Ñ!"); return; }
Â  Â  Â  Â  currentRankLogin = login;
Â  Â  Â  Â  document.getElementById('roleTargetName').innerText = currentName;
Â  Â  Â  Â  document.getElementById('roleModal').classList.remove('role-hidden');
Â  Â  }

Â  Â  window.setRole = function(newRole) {
Â  Â  Â  Â  if (!currentRankLogin) return;
Â  Â  Â  Â  update(ref(db, 'users/' + currentRankLogin), { role: newRole })
Â  Â  Â  Â  Â  Â  .then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  alert(`Ğ Ğ¾Ğ»ÑŒ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ°!`);
Â  Â  Â  Â  Â  Â  Â  Â  closeRoleModal();
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .catch(e => alert("ĞÑˆĞ¸Ğ±ĞºĞ°: " + e));
Â  Â  }

Â  Â  window.closeRoleModal = function() {
Â  Â  Â  Â  document.getElementById('roleModal').classList.add('role-hidden');
Â  Â  Â  Â  currentRankLogin = null;
Â  Â  }

Â  Â  window.toggleSidebar = function() {
Â  Â  Â  Â  document.getElementById('sidebar').classList.toggle('open');
Â  Â  }

Â  Â  window.showView = function(viewName) {
Â  Â  Â  Â  document.getElementById('sidebar').classList.remove('open');
Â  Â  Â  Â  document.getElementById('view-game').classList.add('hidden');
Â  Â  Â  Â  document.getElementById('view-journal').classList.add('hidden');
Â  Â  Â  Â  document.getElementById('view-chat').classList.add('hidden');
Â  Â  Â  Â  document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));

Â  Â  Â  Â  if (viewName === 'game') {
Â  Â  Â  Â  Â  Â  document.getElementById('view-game').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById('btn-nav-game').classList.add('active');
Â  Â  Â  Â  } else if (viewName === 'chat') {
Â  Â  Â  Â  Â  Â  document.getElementById('view-chat').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById('btn-nav-chat').classList.add('active');
Â  Â  Â  Â  Â  Â  const container = document.getElementById('chatMessages');
Â  Â  Â  Â  Â  Â  setTimeout(() => container.scrollTop = container.scrollHeight, 100);
Â  Â  Â  Â  } else if (viewName === 'journal') {
Â  Â  Â  Â  Â  Â  document.getElementById('view-journal').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById('btn-nav-journal').classList.add('active');
Â  Â  Â  Â  }
Â  Â  }

Â  Â  window.downloadCSV = function() { const rows = document.querySelectorAll('#scoreTable tbody tr'); if (rows.length === 0) { alert("ĞŸÑƒÑÑ‚Ğ¾!"); return; } const selectedDate = document.getElementById('gameDate').value; let formattedDate = selectedDate; if(selectedDate) { const parts = selectedDate.split('-'); formattedDate = `${parts[2]}.${parts[1]}.${parts[0]}`; } let csvContent = `Ğ”Ğ°Ñ‚Ğ° Ğ²Ñ‹Ğ¿Ğ¸ÑĞºĞ¸:;${formattedDate}\n\n`; csvContent += "Ğ˜Ğ¼Ñ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°;Ğ˜Ğ¢ĞĞ“ĞĞ’ĞĞ¯ Ğ¡Ğ£ĞœĞœĞ;Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹ ->\n"; rows.forEach(row => { let name = row.querySelector('.player-name').value.trim(); if (!name) name = "Ğ‘ĞµĞ· Ğ¸Ğ¼ĞµĞ½Ğ¸"; let total = row.querySelector('.score-cell').innerText; let opsString = row.querySelector('.history-log').innerText.replace(/\s/g, ';'); csvContent += `"${name}";${total};${opsString}\n`; }); let grandTotal = document.getElementById('grandTotal').innerText; csvContent += `\n"ĞĞ‘Ğ©Ğ˜Ğ™ Ğ‘ĞĞĞš";"${grandTotal}"\n`; const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); const url = URL.createObjectURL(blob); link.setAttribute("href", url); link.setAttribute("download", `Ğ’Ñ‹Ğ¿Ğ¸ÑĞºĞ° Ğ·Ğ° ${formattedDate}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); }
</script>

</body>
</html>
